<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studentsweeps Platform - Entries & Prizes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Orbitron:wght@400..900&display=swap');

        :root {
            --accent-color-dark: #009b40;
            --accent-color: #00C853;
            --bg-primary: #ffffff;
            --text-primary: #1f2937;
            --border-color: #e5e7eb;
            --text-secondary: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            /* Background pattern on the right side - like Figma design */
            background-image: url('images/homepage.jpg');
            background-size: auto;
            background-position: right top;
            background-repeat: repeat-y;
            background-attachment: fixed;
        }

        html {
            scroll-behavior: smooth;
        }

        .text-accent {
            color: var(--accent-color);
        }

        .bg-accent {
            background-color: var(--accent-color);
        }

        .hover\:bg-accent-dark:hover {
            background-color: var(--accent-color-dark);
        }

        .highlight-text {
            color: var(--accent-color);
            font-weight: 600;
        }

        .ring-accent {
            --tw-ring-color: var(--accent-color);
        }

        .border-accent {
            border-color: var(--accent-color);
        }

        /* Payment Provider Selection Styles */
        .payment-provider-label.provider-selected {
            border-color: var(--accent-color) !important;
            background-color: rgba(0, 200, 83, 0.1) !important;
            box-shadow: 0 10px 15px -3px rgba(0, 200, 83, 0.2), 0 4px 6px -2px rgba(0, 200, 83, 0.1) !important;
            outline: 2px solid rgba(0, 200, 83, 0.3);
            outline-offset: 2px;
        }

        .payment-provider-label.provider-selected .provider-indicator {
            border-color: var(--accent-color) !important;
            background-color: var(--accent-color) !important;
        }

        .payment-provider-label.provider-selected .provider-dot {
            opacity: 1 !important;
        }

        .payment-provider-label.provider-selected .provider-label {
            color: var(--accent-color) !important;
            font-weight: 700 !important;
        }

        .payment-provider-label.provider-selected .provider-icon {
            color: var(--accent-color) !important;
            transform: scale(1.1);
        }

        .payment-provider-label.provider-selected .provider-check {
            opacity: 1 !important;
        }

        header {
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .header-nav .active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 2px;
        }

        #mobile-menu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        #mobile-menu.menu-open {
            transform: translateX(0);
        }

        footer {
            background-color: #f3f4f6;
            color: #6b7280;
            padding-top: 4rem;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            display: none !important;
        }

        .loader {
            border: 5px solid rgba(0, 200, 83, 0.1);
            border-top: 5px solid var(--accent-color);
            border-right: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.2);
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            margin-top: 16px;
            text-align: center;
            letter-spacing: 0.5px;
            animation: pulse 2s ease-in-out infinite;
        }

        .loading-subtext {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 8px;
            text-align: center;
            opacity: 0.8;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .timer-font {
            font-family: 'Orbitron', sans-serif;
        }

        .digit-card-face {
            background-color: #f9fafb;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .front-face {
            z-index: 2;
            transform: rotateX(0deg);
        }

        .back-face {
            z-index: 1;
            transform: rotateX(180deg);
        }

        .digit-card {
            perspective: 1000px;
        }

        .digit-card-inner {
            transition: transform 0.3s ease-in-out;
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .digit-card.flipping .digit-card-inner {
            transform: rotateX(180deg);
        }

        .card-bg {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .product-option-button {
            border: 1px solid var(--border-color);
            color: #374151;
            transition: all 0.2s;
        }

        .product-option-button:hover,
        .product-option-button.active {
            border-color: var(--accent-color);
            background-color: #e6ffec;
            color: var(--text-primary);
            font-weight: 600;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: #fff;
            transition: background 0.2s;
        }

        .btn-accent:hover {
            background-color: var(--accent-color-dark);
            color: #fff;
        }

        .winner-tile {
            position: relative;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .winner-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .winner-image-container {
            position: relative;
            overflow: hidden;
            padding-top: 100%;
        }

        .winner-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-overlay,
        #message-box {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-panel,
        #message-box>div {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .is-hidden {
            opacity: 0;
            visibility: hidden;
        }

        .is-visible {
            opacity: 1;
            visibility: visible;
        }

        .is-hidden .modal-panel,
        .is-hidden #message-box>div {
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
        }

        .is-visible .modal-panel,
        .is-visible #message-box>div {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .profile-nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            color: #4b5563;
            font-weight: 500;
        }

        .profile-nav-link.active {
            background-color: #e6ffec;
            color: var(--accent-color);
            font-weight: 600;
        }

        .profile-nav-link:hover {
            background-color: #f3f4f6;
        }

        .profile-nav-link.active:hover {
            background-color: #d1fae5;
        }


        #main-content {
            position: relative;
            min-height: calc(100vh - 200px);
        }

        /* Ensure content is above background */
        #main-content>* {
            position: relative;
            z-index: 1;
        }

        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background: white;
            border-radius: 9999px;
            height: 1.25rem;
            width: 1.25rem;
            transition: transform 0.2s;
        }

        input:checked+.toggle-bg {
            background-color: var(--accent-color);
        }

        input:checked+.toggle-bg:after {
            transform: translateX(100%);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="text-center">
            <div class="loader mb-4"></div>
            <p class="text-lg font-semibold text-gray-700">Loading Studentsweeps...</p>
        </div>
    </div>

    <!-- Header and Navigation -->
    <header class="sticky top-0 z-30 bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <!-- Hamburger Menu Button (Mobile Only) --><button id="hamburger-btn"
                class="md:hidden mr-4 p-2 text-gray-600 hover:text-accent focus:outline-none" aria-label="Open menu">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>

            <!-- Logo --><a href="#" class="text-2xl font-extrabold tracking-wider text-gray-900 flex-shrink-0"
                onclick="changePage('home', null, event)">
                Studentsweeps<span class="text-accent">.</span>
            </a>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex flex-grow justify-center space-x-6 lg:space-x-10 header-nav">

                <a href="#" class="nav-link text-gray-600 hover:text-accent py-1 transition duration-150"
                    data-page="prizes" onclick="changePage('prizes', null, event)">All Prizes</a>
                <a href="#" class="nav-link text-gray-600 hover:text-accent py-1 transition duration-150"
                    data-page="donations" onclick="changePage('donations', null, event)">Donations</a>
                <a href="#" class="nav-link text-gray-600 hover:text-accent py-1 transition duration-150"
                    data-page="winners" onclick="changePage('winners', null, event)">Winners</a>
                <a href="#" class="nav-link text-gray-600 hover:text-accent py-1 transition duration-150"
                    data-page="partners" onclick="changePage('partners', null, event)">Partners</a>
                <a href="#" class="nav-link text-gray-600 hover:text-accent py-1 transition duration-150"
                    data-page="about" onclick="changePage('about', null, event)">About Us</a>
            </nav>

            <!-- Auth Container (Profile Dropdown/Sign In Button) -->
            <div id="auth-container" class="relative ml-4 flex-shrink-0">
                <!-- Managed by JavaScript -->
            </div>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"
        onclick="closeMobileMenu()"></div>
    <!-- Mobile Menu Panel -->
    <div id="mobile-menu" class="fixed top-0 left-0 w-64 h-full bg-white shadow-lg z-50 p-6 space-y-4 md:hidden">
        <!-- Added md:hidden, remove hidden initially --><button onclick="closeMobileMenu()"
            class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
        <h2 class="text-xl font-bold mb-6">Menu</h2>
        <a href="#" class="block py-2 text-gray-700 hover:text-accent mobile-nav-link" data-page="prizes"
            onclick="handleMobileNavClick('home', null, event)">Home</a>
        <a href="#" class="block py-2 text-gray-700 hover:text-accent mobile-nav-link" data-page="prizes"
            onclick="handleMobileNavClick('prizes', null, event)">All Prizes</a>
        <a href="#" class="block py-2 text-gray-700 hover:text-accent mobile-nav-link" data-page="donations"
            onclick="handleMobileNavClick('donations', null, event)">Donations</a>
        <a href="#" class="block py-2 text-gray-700 hover:text-accent mobile-nav-link" data-page="winners"
            onclick="handleMobileNavClick('winners', null, event)">Winners</a>
        <a href="#" class="block py-2 text-gray-700 hover:text-accent mobile-nav-link" data-page="partners"
            onclick="handleMobileNavClick('partners', null, event)">Partners</a>
        <a href="#" class="block py-2 text-gray-700 hover:text-accent mobile-nav-link" data-page="about"
            onclick="handleMobileNavClick('about', null, event)">About Us</a>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Loading...</div>
        <div class="loading-subtext">Please wait while we prepare everything for you</div>
    </div>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 relative"></main>

    <!-- Footer -->
    <footer class="mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 text-gray-500">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 border-b border-gray-300 pb-8 mb-8">
                <div>
                    <h3 class="text-xl font-extrabold tracking-wider text-gray-900 mb-4">Studentsweeps<span
                            class="text-accent">.</span></h3>
                    <p class="text-sm">We give away epic prizes and support great causes. Join the excitement!</p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase text-gray-700 mb-4">Quick Links</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" onclick="changePage('prizes', null, event)"
                                class="hover:text-accent transition">All Prizes</a></li>
                        <li><a href="#" onclick="changePage('winners', null, event)"
                                class="hover:text-accent transition">Recent Winners</a></li>
                        <li><a href="#" onclick="changePage('donations', null, event)"
                                class="hover:text-accent transition">Charity Impact</a></li>
                        <li><a href="#" onclick="changePage('about', null, event)"
                                class="hover:text-accent transition">About Us</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase text-gray-700 mb-4">Follow Us</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-accent transition flex items-center"><i
                                    data-lucide="instagram" class="w-4 h-4 mr-2"></i> Instagram</a></li>
                        <li><a href="#" class="hover:text-accent transition flex items-center"><i data-lucide="youtube"
                                    class="w-4 h-4 mr-2"></i> YouTube</a></li>
                        <li><a href="#" class="hover:text-accent transition flex items-center"><i data-lucide="facebook"
                                    class="w-4 h-4 mr-2"></i> Facebook</a></li>
                        <li><a href="#" class="hover:text-accent transition flex items-center"><i data-lucide="twitter"
                                    class="w-4 h-4 mr-2"></i> Twitter</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-sm font-semibold uppercase text-gray-700 mb-4">Newsletter</h4>
                    <form onsubmit="handleNewsletterSubmit(event)">
                        <input type="email" placeholder="Your email address"
                            class="w-full p-3 mb-2 rounded-lg bg-white text-gray-900 border border-gray-300 focus:ring-accent focus:border-accent">
                        <button type="submit"
                            class="w-full bg-accent hover:bg-accent-dark text-white font-semibold py-3 rounded-lg transition">Subscribe</button>
                    </form>
                </div>
            </div>
            <div class="text-center text-sm text-gray-500">
                &copy; 2025 Studentsweeps. All rights reserved. | <a href="#" class="hover:text-accent">Terms &
                    Conditions</a> | <a href="#" class="hover:text-accent">Privacy Policy</a>
            </div>
        </div>
    </footer>

    <!-- Global Message Box -->
    <div id="message-box" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-[60] is-hidden">
        <!-- Increased z-index -->
        <div class="fixed inset-0 bg-black bg-opacity-50"
            onclick="document.getElementById('message-box').classList.add('is-hidden')"></div>
        <!-- Added overlay close -->
        <div class="modal-panel relative bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <p id="message-text" class="text-gray-800 text-lg mb-6"></p>
            <button onclick="document.getElementById('message-box').classList.add('is-hidden')"
                class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg transition duration-200 text-lg">
                OK
            </button>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 is-hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeAuthModal()"></div>
        <div class="modal-panel relative bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 sm:p-10">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700"><i
                    data-lucide="x" class="w-6 h-6"></i></button>
            <div id="login-view">
                <h2 class="text-3xl font-bold text-center text-gray-900">Welcome Back!</h2>
                <p class="text-center text-gray-500 mt-2">Sign in to continue to Studentsweeps.</p>
                <form onsubmit="handleLogin(event)" class="mt-8 space-y-6">
                    <div><input id="login-email" type="email" autocomplete="email" required
                            class="w-full p-3 rounded-lg bg-gray-100" placeholder="Email address"></div>
                    <div><input id="login-password" type="password" autocomplete="current-password" required
                            class="w-full p-3 rounded-lg bg-gray-100" placeholder="Password"></div>
                    <div class="text-right text-sm"><a href="#" onclick="switchAuthView('forgot-password', event)"
                            class="font-medium text-accent hover:text-green-600">Forgot password?</a></div>
                    <button type="submit"
                        class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg">Sign
                        In</button>
                    <p class="text-center text-sm text-gray-600">Don't have an account? <a href="#"
                            onclick="switchAuthView('signup', event)" class="font-medium text-accent">Sign Up</a></p>
                </form>
            </div>
            <div id="signup-view" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-900">Create Account</h2>
                <p class="text-center text-gray-500 mt-2">Join us to win amazing prizes!</p>
                <form onsubmit="handleSignup(event)" class="mt-8 space-y-6">
                    <div><input id="signup-fullname" type="text" autocomplete="name" required
                            class="w-full p-3 rounded-lg bg-gray-100" placeholder="Full name"></div>
                    <div><input id="signup-email" type="email" autocomplete="email" required
                            class="w-full p-3 rounded-lg bg-gray-100" placeholder="Email address"></div>
                    <div><input id="signup-password" type="password" autocomplete="new-password" required
                            class="w-full p-3 rounded-lg bg-gray-100" placeholder="Create Password"></div>
                    <button type="submit"
                        class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg">Create
                        Account</button>
                    <p class="text-center text-sm text-gray-600">Already have an account? <a href="#"
                            onclick="switchAuthView('login', event)" class="font-medium text-accent">Sign In</a></p>
                </form>
            </div>
            <div id="forgot-password-view" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-900">Reset Password</h2>
                <p class="text-center text-gray-500 mt-2">Enter your email to get a reset link.</p>
                <form onsubmit="handleForgotPassword(event)" class="mt-8 space-y-6">
                    <div><input id="forgot-email" type="email" autocomplete="email" required
                            class="w-full p-3 rounded-lg bg-gray-100" placeholder="Email address"></div>
                    <button type="submit"
                        class="w-full bg-accent hover:bg-accent-dark text-white font-bold py-3 rounded-lg">Send Reset
                        Link</button>
                    <p class="text-center text-sm text-gray-600">Remembered your password? <a href="#"
                            onclick="switchAuthView('login', event)" class="font-medium text-accent">Sign In</a></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 is-hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeTransactionModal()"></div>
        <div class="modal-panel relative bg-white rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="p-6 border-b">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Transaction Details</h2>
                        <p id="tx-id" class="text-sm text-gray-500"></p>
                    </div>
                    <button onclick="closeTransactionModal()" class="text-gray-400 hover:text-gray-700"><i
                            data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div class="p-6 space-y-4 text-gray-700">
                <div class="flex justify-between"><span class="font-medium">Prize:</span><span id="tx-prize"
                        class="font-semibold text-right"></span></div>
                <div class="flex justify-between"><span class="font-medium">Date:</span><span id="tx-date"
                        class="text-right"></span></div>
                <div class="flex justify-between items-center"><span class="font-medium">Status:</span><span
                        id="tx-status" class="text-right"></span></div>
                <hr>
                <div class="flex justify-between"><span class="font-medium">Entries Purchased:</span><span
                        id="tx-entries" class="text-right"></span></div>
                <div class="flex justify-between"><span class="font-medium">Cost per Entry:</span><span id="tx-cost"
                        class="text-right"></span></div>
                <div class="flex justify-between text-lg font-bold text-accent"><span class="text-gray-900">Total
                        Cost:</span><span id="tx-total" class="text-right"></span></div>
                <hr>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="font-medium text-sm text-gray-800">Your Entry Numbers:</p>
                    <p id="tx-entry-numbers" class="text-xs text-gray-600 break-words"></p>
                </div>
            </div>
            <div class="p-6 bg-gray-50 rounded-b-2xl text-right">
                <button onclick="closeTransactionModal()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 is-hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeCheckoutModal()"></div>
        <!-- RESPONSIVE MODAL PANEL: max-h-[90vh] overflow-y-auto added for mobile scrolling -->
        <div
            class="modal-panel relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-auto max-h-[90vh] overflow-y-auto">

            <!-- Header -->
            <div class="p-6 pb-2 border-b flex flex-col items-center justify-center relative">
                <h2 class="text-2xl font-bold text-gray-900 mb-1">Checkout</h2>
                <!-- mb-1 for tighter spacing on "Checkout" -->
                <p class="text-sm text-gray-500 mb-4">Final step to secure your entries!</p>
                <!-- mb-4 for more space below tagline -->
                <button onclick="closeCheckoutModal()"
                    class="absolute top-6 right-6 text-gray-400 hover:text-gray-700"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <!-- MAIN CONTENT: 2 COLUMNS -->
            <div class="p-6 grid lg:grid-cols-2 gap-8">

                <!-- LEFT COLUMN: BILLING & PAYMENT -->
                <div class="space-y-6">

                    <!-- Billing Address Section -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-bold flex items-center text-gray-900"><i data-lucide="map-pin"
                                class="w-5 h-5 mr-2 text-accent"></i>Billing Address</h3>
                        <form id="billing-form" class="space-y-3">
                            <!-- Name & Email -->
                            <div class="grid grid-cols-2 gap-3">
                                <div><input type="text" id="billing-fullname" required readonly
                                        class="w-full p-2.5 text-sm rounded-lg bg-gray-50 border border-gray-300 text-gray-700 cursor-not-allowed"
                                        placeholder="Full Name *"></div>
                                <div><input type="email" id="billing-email" required readonly
                                        class="w-full p-2.5 text-sm rounded-lg bg-gray-50 border border-gray-300 text-gray-700 cursor-not-allowed"
                                        placeholder="Email Address *"></div>
                            </div>
                            <!-- Address Fields -->
                            <div><input type="text" id="billing-address1" required
                                    class="w-full p-2.5 text-sm rounded-lg bg-gray-100 border border-gray-300 focus:ring-accent focus:border-accent"
                                    placeholder="Address Line 1 *"></div>
                            <div><input type="text" id="billing-address2"
                                    class="w-full p-2.5 text-sm rounded-lg bg-gray-100 border border-gray-300 focus:ring-accent focus:border-accent"
                                    placeholder="Address Line 2 (Optional)"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><input type="text" id="billing-city" required
                                        class="w-full p-2.5 text-sm rounded-lg bg-gray-100 border border-gray-300 focus:ring-accent focus:border-accent"
                                        placeholder="City *"></div>
                                <div><input type="text" id="billing-zip" required
                                        class="w-full p-2.5 text-sm rounded-lg bg-gray-100 border border-gray-300 focus:ring-accent focus:border-accent"
                                        placeholder="Zip/Postal Code *"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <select id="billing-country" required
                                        class="w-full p-2.5 text-sm rounded-lg bg-gray-100 border border-gray-300 focus:ring-accent focus:border-accent text-gray-500">
                                        <option value="">Select Country *</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="AU">Australia</option>
                                    </select>
                                </div>
                                <div><input type="text" id="billing-state"
                                        class="w-full p-2.5 text-sm rounded-lg bg-gray-100 border border-gray-300 focus:ring-accent focus:border-accent"
                                        placeholder="State/Province"></div>
                            </div>
                        </form>
                    </div>

                    <!-- Select Payment Provider -->
                    <div class="space-y-3 pt-4">
                        <h3 class="text-lg font-bold flex items-center text-gray-900"><i data-lucide="wallet"
                                class="w-5 h-5 mr-2 text-accent"></i>Select Payment Provider</h3>
                        <div class="space-y-2" id="payment-providers-container">
                            <!-- Dynamically populated by renderCheckoutModal() -->
                        </div>
                    </div>

                    <!-- Save Information Checkbox -->
                    <div class="flex items-center pt-2">
                        <input id="save-payment" type="checkbox"
                            class="h-4 w-4 text-accent rounded focus:ring-accent accent-accent">
                        <label for="save-payment" class="ml-2 text-sm text-gray-700">Save this information for next
                            time</label>
                    </div>
                </div>

                <!-- RIGHT COLUMN: ORDER SUMMARY -->
                <div class="space-y-6">
                    <!-- Added ring-4 ring-green-100 and border-2 border-accent for distinct style -->
                    <div class="p-6 rounded-xl bg-gray-50 border border-2 border-accent ring-4 ring-green-100">
                        <h3 class="text-lg font-bold text-gray-900 border-b pb-2 mb-3">Your Order</h3>
                        <div class="space-y-3 text-sm">
                            <!-- Prize/Donation Title & Price -->
                            <div class="space-y-1 pb-2 border-b border-gray-200">
                                <p id="checkout-order-type-label" class="text-xs text-gray-500">Winning Prize:</p>
                                <div class="flex justify-between items-center">
                                    <span id="checkout-order-title" class="font-bold text-gray-800"></span>
                                    <span id="checkout-order-price" class="font-bold text-accent">$0.00 <span
                                            class="text-xs text-gray-500 font-normal">per entry</span></span>
                                </div>
                            </div>

                            <!-- Quantity Label -->
                            <div class="flex justify-between pt-2">
                                <span id="checkout-quantity-label" class="text-gray-600">Entries Purchased:</span>
                                <span id="checkout-order-entries" class="font-medium">0</span>
                            </div>

                            <!-- Subtotal -->
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal:</span>
                                <span id="checkout-order-subtotal" class="font-medium">$0.00</span>
                            </div>

                            <!-- Total Due -->
                            <div class="pt-4 border-t border-gray-300">
                                <div class="flex justify-between items-center text-3xl font-extrabold">
                                    <span class="text-gray-900">Total Due:</span>
                                    <span id="checkout-order-total" class="text-accent">$0.00</span>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-1 text-right">(External provider fees may apply
                                    after selection)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer/Action Button -->
            <div class="p-6 border-t border-gray-200 text-center">
                <button onclick="finalizeCheckout()"
                    class="w-full bg-accent hover:bg-accent-dark text-white font-extrabold py-3 px-6 rounded-lg transition duration-200 shadow-lg flex items-center justify-center">
                    <span class="mr-1">Confirm Purchase & Pay</span> <span id="checkout-confirm-amount">$0.00</span>
                </button>
                <!-- Enhanced Security Message -->
                <p class="text-xs text-gray-500 mt-2 flex items-center justify-center font-medium">
                    <i data-lucide="shield-check" class="w-3 h-3 inline mr-1 text-accent"></i>
                    **100% Secured Transaction.** Encrypted by industry-leading SSL. Your data is protected.
                </p>
            </div>
        </div>
    </div>




    <!-- Socket.IO client + SocketClient library -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="./socketClient.browser.js"></script>
    <script>
        // Initialize Socket Client AFTER scripts are loaded
        // Wait for both socket.io and SocketClient to be ready
        function initializeSocketClient() {
            console.log('[index.html] Attempting to initialize SocketClient...');
            console.log('[index.html] Socket.io loaded:', typeof window.io !== 'undefined');
            console.log('[index.html] SocketClient loaded:', typeof window.SocketClient !== 'undefined');

            // Check if both are ready
            if (!window.io) {
                console.warn('[index.html] Socket.io not ready yet, waiting...');
                setTimeout(initializeSocketClient, 100);
                return;
            }

            if (!window.SocketClient) {
                console.error('[index.html] SocketClient not found! Check if socketClient.browser.js loaded correctly.');
                return;
            }

            // Check if already initialized
            if (window.SocketClient.isConnected && window.SocketClient.isConnected()) {
                console.log('[index.html] SocketClient already connected, skipping init');
                return;
            }

            console.log('[index.html] Both ready, initializing SocketClient...');
            try {
                window.SocketClient.init();
            } catch (err) {
                console.error('[index.html] Error during SocketClient.init():', err);
            }
        }

        // Try initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSocketClient);
        } else {
            // DOM already loaded, initialize immediately
            initializeSocketClient();
        }
        
        // CRITICAL: Re-ensure socket listeners when user comes back from payment page
        // This fixes the issue where user goes back and tries to checkout again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && window.SocketClient) {
                // Page became visible (user came back)
                console.log('[index.html] Page became visible - re-ensuring socket connection and listeners...');
                
                const socketInstance = window.SocketClient._getSocket ? window.SocketClient._getSocket() : null;
                
                if (socketInstance && socketInstance.connected) {
                    // Socket is connected, ensure purchase listeners are active
                    console.log('[index.html] Socket connected, ensuring purchase listeners...');
                    if (window.SocketClient.ensurePurchaseListeners) {
                        window.SocketClient.ensurePurchaseListeners();
                    }
                } else if (!socketInstance || !socketInstance.connected) {
                    // Socket not connected, try to reconnect
                    console.log('[index.html] Socket not connected, attempting to reconnect...');
                    if (window.SocketClient.init) {
                        window.SocketClient.init();
                    }
                }
            }
        });
        
        // Also listen for pageshow event (handles browser back/forward navigation)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted && window.SocketClient) {
                // Page was loaded from cache (browser back button)
                console.log('[index.html] Page loaded from cache (browser back) - re-ensuring socket...');
                
                const socketInstance = window.SocketClient._getSocket ? window.SocketClient._getSocket() : null;
                
                if (socketInstance && socketInstance.connected) {
                    if (window.SocketClient.ensurePurchaseListeners) {
                        window.SocketClient.ensurePurchaseListeners();
                    }
                } else {
                    if (window.SocketClient.init) {
                        window.SocketClient.init();
                    }
                }
            }
        });
    </script>
    <script>
        // --- Mock Data & Config ---
        const API_KEY = "";

        // Data arrays will be populated from the server via sockets (PRODUCTION - No mock data)
        // Initialize as window globals directly so socket client can update them
        window.PRIZES = [];
        window.PAST_PRIZES = [];
        window.DONATIONS = [];
        window.WINNERS = [];
        window.TRANSACTIONS = [];
        window.PAYMENT_OPTIONS = [];
        window.APP_SETTINGS = {};

        // --- Global State ---
        let currentInterval = null, currentPage = 'home', currentProfileTab = 'overview';
        window.currentPage = 'home';  // Make accessible to socket client
        // currentPrizeId/currentDonationId will be set when data arrives; safe defaults to null
        let currentPrizeId = window.PRIZES.length ? window.PRIZES[0]._id : null;
        let currentDonationId = window.DONATIONS.length ? window.DONATIONS[0]._id : null;
        const mainContentEl = document.getElementById('main-content');
        // Global state
        let selectedEntryOption = 1;
        let isLoggedIn = false;
        let currentUser = null;

        // Socket client integration hooks
        window.onAuthStateChanged = function (user) {
            if (user) {
                currentUser = user;
                isLoggedIn = true;
            } else {
                currentUser = null;
                isLoggedIn = false;
            }
            renderHeader();
        };

        window.onUserUpdate = function (user) {
            console.log('[Frontend] User update received:', user);
            currentUser = user;
            window.currentUser = user;
            // Also save to localStorage
            if (window.SocketClient) {
                window.SocketClient.setUser(user);
            }
            renderHeader();
            if (currentPage === 'profile') {
                renderProfilePage();
            }
        };
        // Checkout modal state
        let checkoutState = {
            itemName: null,
            itemPrice: 0,
            quantity: 0,
            isEntries: false,
            prizeId: null,
            donationId: null
        };
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const hamburgerBtn = document.getElementById('hamburger-btn');

        // --- Timer Helper Functions ---
        const formatTime = (num) => String(num).padStart(2, '0');
        function getFaces(unitElement) { const inner = unitElement.querySelector('.digit-card-inner'); const front = unitElement.querySelector('.front-face'); const back = unitElement.querySelector('.back-face'); const frontValue = front ? front.getAttribute('data-value') : '00'; return { unitElement, inner, front, back, frontValue }; }
        function updateUnit(unitElement, newValue) { const { unitElement: unit, front, back, frontValue } = getFaces(unitElement); if (!unit || newValue === frontValue) return; if (front && back) { back.textContent = newValue; back.setAttribute('data-value', newValue); unit.classList.add('flipping'); setTimeout(() => { front.textContent = newValue; front.setAttribute('data-value', newValue); unit.classList.remove('flipping'); }, 150); } }
        function startCountdown(targetTime) {
            if (currentInterval) { clearInterval(currentInterval); currentInterval = null; } const daysEl = document.getElementById('days-unit'); if (!daysEl) return; const update = () => { const now = new Date().getTime(); const distance = targetTime - now; const hoursEl = document.getElementById('hours-unit'); const minutesEl = document.getElementById('minutes-unit'); const secondsEl = document.getElementById('seconds-unit'); const messageEl = document.getElementById('draw-message'); if (!daysEl || !hoursEl || !minutesEl || !secondsEl) { clearInterval(currentInterval); currentInterval = null; return; } if (distance < 0) { clearInterval(currentInterval); currentInterval = null; const timerEl = document.getElementById('countdown-timer'); if (timerEl) timerEl.innerHTML = ''; if (messageEl) messageEl.innerHTML = `<p class="text-xl font-bold text-red-500">DRAW IS CLOSED!</p>`; return; } const days = Math.floor(distance / (1000 * 60 * 60 * 24)); const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000); updateUnit(daysEl, formatTime(days)); updateUnit(hoursEl, formatTime(hours)); updateUnit(minutesEl, formatTime(minutes)); updateUnit(secondsEl, formatTime(seconds)); if (messageEl) messageEl.innerHTML = `<span class="text-lg font-bold text-gray-900">Ends ${new Date(targetTime).toLocaleDateString()}</span>`; };
            currentInterval = setInterval(update, 1000); update();
        }

        // --- HTML Rendering Functions ---
        function renderHomePage() {
            // Hide loading screen when rendering
            if (typeof window.hideLoading === 'function') {
                window.hideLoading();
            }

            if (currentInterval) clearInterval(currentInterval);

            // Render immediately with whatever data is available
            console.log('[Home] Rendering with data:', { prizes: window.PRIZES?.length || 0, donations: window.DONATIONS?.length || 0, past: window.PAST_PRIZES?.length || 0 });

            // Limit to 3 cards per section using slice(), use new fallback image logic
            const FALLBACK_IMAGE = 'https://placehold.co/300x200?text=No+Image';
            const now = Date.now();

            // Featured Prizes: Only show active prizes (not drawn, and drawTimestamp in future or no drawTimestamp)
            const activePrizes = (window.PRIZES || []).filter(p => {
                if (!p || !p._id || !p.name) return false;
                // Exclude drawn prizes
                if (p.status === 'drawn') return false;
                // Only show prizes with future draw dates (or no draw date)
                if (p.drawTimestamp) {
                    const drawDate = new Date(p.drawTimestamp).getTime();
                    return drawDate > now;
                }
                return true; // Include prizes without drawTimestamp
            });
            const featuredPrizes = activePrizes.slice(0, 3).map(p => {
                // Truncate short description to max 100 characters for listing display
                const shortDesc = p.shortDescription || '';
                const truncatedDesc = shortDesc.length > 100 ? shortDesc.substring(0, 100) + '...' : shortDesc;
                return `
    <div onclick="changePage('detail', '${p._id}', event)" class="bg-white rounded-xl overflow-hidden shadow-lg card-bg cursor-pointer hover:shadow-lg transition duration-300">
        <img src="${p.thumbnail || FALLBACK_IMAGE}" alt="${p.name}" class="w-full h-52 object-cover" onerror="this.src='${FALLBACK_IMAGE}'" />
        <div class="p-4 space-y-1">
            <h4 class="text-lg font-bold">${p.name}</h4>
            <p class="text-xs text-gray-500">${truncatedDesc}</p>
        </div>
    </div>
`;
            }).join('') || '<p class="text-gray-500 col-span-full text-center py-8">No prizes available at the moment.</p>';

            const donationTiles = (window.DONATIONS || []).slice(0, 3).filter(d => d && d._id && d.name).map(d => {
                const donationImage = d.image || '';
                const FALLBACK_DONATION_IMAGE = 'https://placehold.co/400x300?text=Donation';
                return ` <div onclick="changePage('donation_detail', '${d._id}', event)" class="bg-white p-4 rounded-xl shadow-md card-bg cursor-pointer hover:shadow-lg transition duration-300"> ${donationImage ? `<img src="${donationImage}" alt="${d.name}" class="w-full h-48 object-cover rounded-lg mb-3" onerror="this.src='${FALLBACK_DONATION_IMAGE}'; this.onerror=null;" />` : `<div class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 mb-3"><i data-lucide="heart" class="w-8 h-8"></i></div>`} <h4 class="text-md font-semibold text-accent">${d.name}</h4> <p class="text-sm text-gray-500 mt-1">${(d.shortDescription || d.name).substring(0, 70)}...</p> <button class="text-sm text-accent hover:text-green-600 mt-2 font-medium">Read More &rarr;</button> </div> `;
            }).join('');

            // Past Prizes: Include drawn prizes and prizes with past draw dates
            const drawnPrizes = (window.PRIZES || []).filter(p => {
                if (!p || !p._id || !p.name) return false;
                // Include drawn prizes
                if (p.status === 'drawn') return true;
                // Include prizes with past draw dates
                if (p.drawTimestamp) {
                    const drawDate = new Date(p.drawTimestamp).getTime();
                    return drawDate <= now;
                }
                return false;
            });
            // Combine PAST_PRIZES and drawn/expired prizes, remove duplicates
            const allPastPrizes = [...(window.PAST_PRIZES || []), ...drawnPrizes].filter((p, index, self) =>
                index === self.findIndex(prize => String(prize._id) === String(p._id))
            );
            const pastPrizes = allPastPrizes.slice(0, 3).map(p => {
                // Truncate short description to max 80 characters for past prizes display
                const shortDesc = p.shortDescription || '';
                const truncatedDesc = shortDesc.length > 80 ? shortDesc.substring(0, 80) + '...' : shortDesc;
                return ` <div onclick="changePage('detail', '${p._id}', event)" class="relative rounded-xl overflow-hidden shadow-lg card-bg cursor-pointer hover:shadow-xl transition duration-300"> <div class="absolute top-2 right-2 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full font-bold z-10">DRAWN</div> <img src="${p.thumbnail || FALLBACK_IMAGE}" alt="${p.name}" class="w-full h-52 object-cover block" onerror="this.src='${FALLBACK_IMAGE}'" /> <div class="p-3"> <p class="text-sm font-semibold">${p.name}</p> <p class="text-xs text-gray-400">${truncatedDesc}</p> </div> </div> `;
            }).join('');
            const html = ` <div class="relative rounded-xl overflow-hidden shadow-xl h-64 sm:h-80 md:h-[400px] mb-12 border"><img src="https://placehold.co/1200x600/5c378e/ffffff?text=Make+Magic+Happen" alt="Hero Image" class="w-full h-full object-cover" /><div class="absolute inset-0 bg-black bg-opacity-40 flex items-center p-6 sm:p-10 md:p-16"><div class="max-w-xs sm:max-w-md space-y-4"><h1 class="text-3xl sm:text-4xl md:text-6xl font-extrabold text-white">Turning student dreams into wins.</h1><p class="text-sm sm:text-lg text-gray-100">We giveaway epic prizes, and support great causes.</p><button onclick="changePage('prizes', null, event)" class="bg-accent hover:bg-accent-dark text-white font-extrabold py-3 px-8 rounded-lg">View Prizes</button></div></div></div><div class="bg-white rounded-lg shadow-md overflow-hidden flex text-center font-semibold mb-8"><div class="flex-1 text-white bg-accent py-3 cursor-pointer">Featured Prizes</div><div class="flex-1 hover:bg-gray-100 py-3 cursor-pointer" onclick="changePage('donations',null,event)">Donations</div><div class="flex-1 hover:bg-gray-100 py-3 cursor-pointer" onclick="changePage('winners',null,event)">Winners</div></div><section class="mb-12"><h2 class="text-2xl font-bold mb-6 border-b pb-2">Featured Prizes</h2><div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6">${featuredPrizes || '<p class="text-gray-500 col-span-full text-center py-8">Loading prizes...</p>'}</div><div class="text-center mt-6"><button onclick="changePage('prizes',null,event)" class="text-accent font-semibold flex items-center justify-center mx-auto">View All <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></button></div></section><section class="mb-12"><h2 class="text-2xl font-bold mb-6 border-b pb-2">Featured Donations</h2><div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6">${donationTiles || '<p class="text-gray-500 col-span-full text-center py-8">Loading causes...</p>'}</div><div class="text-center mt-6"><button onclick="changePage('donations',null,event)" class="text-accent font-semibold flex items-center justify-center mx-auto">View All <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></button></div></section><section class="mb-12"><h2 class="text-2xl font-bold mb-6 border-b pb-2">Past Prizes</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-6">${pastPrizes || '<p class="text-gray-500 col-span-full text-center py-8">No past prizes yet</p>'}</div><div class="text-center mt-6"><button onclick="changePage('prizes',null,event)" class="text-accent font-semibold flex items-center justify-center mx-auto">View All <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i></button></div></section>`;
            mainContentEl.innerHTML = html;
            lucide.createIcons();
        }
        function renderPrizeDetailPage(prizeId) {
            if (!prizeId) {
                renderHomePage();
                return;
            }

            // Try to find prize by ID (handle both string and ObjectId formats)
            // First, try exact match
            let prize = (window.PRIZES || []).find(p => String(p._id) === String(prizeId));
            if (!prize) {
                prize = (window.PAST_PRIZES || []).find(p => String(p._id) === String(prizeId));
            }

            // If still not found, try matching without case sensitivity and with different ID formats
            if (!prize) {
                const allPrizes = [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])];
                prize = allPrizes.find(p => {
                    const pId = String(p._id || p.id || '').toLowerCase();
                    const searchId = String(prizeId || '').toLowerCase();
                    return pId === searchId || pId.includes(searchId) || searchId.includes(pId);
                });
            }

            // If still not found and prizeId looks like it might be a prize name, try searching by name
            // (This handles cases where prizeId is null and we need to search by name from winner card)
            if (!prize && prizeId && prizeId.length > 10 && !prizeId.match(/^[0-9a-f]{24}$/i)) {
                // If prizeId doesn't look like a MongoDB ObjectId, try treating it as a name
                const allPrizes = [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])];
                prize = allPrizes.find(p =>
                    p.name === prizeId || p.name?.toLowerCase() === prizeId?.toLowerCase()
                );
            }

            // Debug logging
            console.log('[Prize Detail] Looking for prize:', {
                prizeId: prizeId,
                prizeIdType: typeof prizeId,
                found: !!prize,
                totalPrizes: (window.PRIZES || []).length,
                totalPastPrizes: (window.PAST_PRIZES || []).length,
                prizeIds: [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])].map(p => String(p._id)).slice(0, 5),
                prizeNames: [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])].map(p => p.name).slice(0, 5)
            });

            // If still not found, show a loading message and wait for data
            if (!prize) {
                mainContentEl.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-500 mb-4">Loading prize details...</p>
                        <p class="text-sm text-gray-400">If this page doesn't load, the prize may no longer be available.</p>
                    </div>
                `;
                // Request prizes data if not already loaded
                if (window.SocketClient && window.SocketClient.isConnected()) {
                    window.SocketClient.emit('prizes:list', {});
                }
                // Try multiple times with increasing delays
                let retryCount = 0;
                const maxRetries = 10; // Increased retries
                const retryInterval = setInterval(() => {
                    retryCount++;
                    // Try to find prize by ID
                    let retryPrize = (window.PRIZES || []).find(p => String(p._id) === String(prizeId)) ||
                        (window.PAST_PRIZES || []).find(p => String(p._id) === String(prizeId));

                    // If not found by ID, try flexible matching
                    if (!retryPrize) {
                        const allPrizes = [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])];
                        retryPrize = allPrizes.find(p => {
                            const pId = String(p._id || p.id || '').toLowerCase();
                            const searchId = String(prizeId || '').toLowerCase();
                            return pId === searchId || pId.includes(searchId) || searchId.includes(pId);
                        });
                    }

                    if (retryPrize) {
                        clearInterval(retryInterval);
                        console.log('[Prize Detail] Found prize on retry:', retryPrize.name);
                        renderPrizeDetailPage(prizeId);
                    } else if (retryCount >= maxRetries) {
                        clearInterval(retryInterval);
                        console.error('[Prize Detail] Prize not found after retries:', {
                            prizeId: prizeId,
                            totalPrizes: (window.PRIZES || []).length,
                            prizeIds: [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])].map(p => String(p._id))
                        });
                        mainContentEl.innerHTML = `
                            <div class="text-center py-12">
                                <p class="text-red-500 mb-4">Prize not found</p>
                                <p class="text-sm text-gray-400 mb-4">The prize you're looking for may no longer be available.</p>
                                <p class="text-xs text-gray-300 mb-4">Prize ID: ${prizeId}</p>
                                <button onclick="changePage('home', null, event)" class="bg-accent hover:bg-accent-dark text-white font-semibold py-2 px-6 rounded-lg">Go to Home</button>
                            </div>
                        `;
                    } else {
                        console.log(`[Prize Detail] Retry ${retryCount}/${maxRetries} - Prize not found yet, checking again...`);
                    }
                }, 500);
                return;
            }
            // Check if prize is past/drawn: either in PAST_PRIZES, has status 'drawn', or drawTimestamp has passed
            const isInPastPrizes = !!(window.PAST_PRIZES || []).find(p => String(p._id) === String(prizeId));
            const isDrawnStatus = prize.status === 'drawn';
            const drawTimestamp = prize.drawTimestamp ? new Date(prize.drawTimestamp) : null;
            const isDrawDatePast = drawTimestamp && drawTimestamp < new Date();
            const isPastPrize = isInPastPrizes || isDrawnStatus || isDrawDatePast;

            // Debug: Log prize data to console
            console.log('[Prize Detail] Prize data:', {
                id: prize._id,
                name: prize.name,
                shortDescription: prize.shortDescription,
                detailedDescription: prize.detailedDescription,
                thumbnail: prize.thumbnail,
                previewImages: prize.previewImages,
                status: prize.status,
                isPastPrize: isPastPrize,
                entries: prize.entries
            });

            const entryOptions = (prize.entries?.minEntriesOrder && prize.entries.minEntriesOrder.length > 0) ? prize.entries.minEntriesOrder : [1, 5, 10, 25, 50];
            selectedEntryOption = entryOptions.length > 1 ? entryOptions[1] : entryOptions[0] || 1;
            const entryPrice = prize.entries?.entryPrice ?? 0;
            const entryButtons = entryOptions.map(o => `<button type="button" data-entries="${o}" onclick="window.selectEntryOption(${o}, event)" class="product-option-button w-full h-20 rounded-lg font-bold flex flex-col items-center justify-center transition ${o === selectedEntryOption ? 'active bg-accent text-white border-accent' : 'border border-gray-300 hover:border-accent'}"><span class="text-xl">${o.toLocaleString()}</span><span class="text-xs font-normal">Entries</span></button>`).join('');
            const specList = (prize.detailsSpecs || []).map(s => `<li class="flex justify-between border-b border-dashed py-2"><span class="text-gray-500">${s.key}</span><span class="font-semibold">${s.value}</span></li>`).join('');
            const FALLBACK_IMAGE = 'https://placehold.co/300x200?text=No+Image';
            const previewImagesHtml = (prize.previewImages || []).filter(img => img).map((img, idx) => `<div onclick="document.getElementById('main-prize-image').src='${img}'" class="aspect-square bg-gray-100 rounded-lg border cursor-pointer hover:border-accent overflow-hidden flex items-center justify-center transition"><img src="${img}" alt="preview ${idx + 1}" class="w-full h-full object-cover" onerror="this.src='${FALLBACK_IMAGE}'" /></div>`).join('');
            const mainImage = prize.thumbnail || FALLBACK_IMAGE;

            // Ensure detailedDescription is displayed even if empty
            const detailedDesc = prize.detailedDescription || '';
            console.log('[Prize Detail] Rendering with:', {
                mainImage: mainImage,
                detailedDescription: detailedDesc,
                previewImagesCount: (prize.previewImages || []).length,
                specsCount: (prize.detailsSpecs || []).length
            });
            // Build Details & Specs content - show detailedDescription as main content, specs as additional info
            let detailsSpecsContent = '';
            if (prize.detailedDescription && prize.detailedDescription.trim()) {
                // If detailed description exists, show it as the main content
                detailsSpecsContent = `<div class="text-gray-700 leading-relaxed">${prize.detailedDescription}</div>`;
                // If there are also specs, show them below the description
                if (specList) {
                    detailsSpecsContent += `<div class="mt-6"><h4 class="text-lg font-semibold mb-3 text-gray-800">Specifications</h4><ul>${specList}</ul></div>`;
                }
            } else if (specList) {
                // If no detailed description but there are specs, show specs
                detailsSpecsContent = `<ul>${specList}</ul>`;
            } else {
                // If neither exists, show "No specs available"
                detailsSpecsContent = '<p class="text-gray-500">No specs available</p>';
            }
            
            const html = `<div class="space-y-12"><div class="pb-2"><h1 class="text-5xl font-extrabold">${prize.name}</h1><p class="text-xl text-gray-500 mt-1">${prize.shortDescription || ''}</p>${isPastPrize ? '<div class="mt-2 text-red-500 font-bold">This draw has closed.</div>' : ''}</div><div class="grid lg:grid-cols-12 gap-10"><div class="lg:col-span-7 space-y-8"><div class="rounded-xl overflow-hidden shadow-lg border"><img id="main-prize-image" src="${mainImage}" alt="${prize.name}" class="w-full h-96 object-cover" onerror="this.src='${FALLBACK_IMAGE}'" /></div><div class="grid grid-cols-6 gap-2">${previewImagesHtml || '<div class="text-gray-400">No preview images</div>'}</div><div class="grid md:grid-cols-2 gap-8 pt-4"><div><h3 class="text-2xl font-bold border-b pb-2">Details & Specs</h3>${detailsSpecsContent}</div></div></div><div class="lg:col-span-5 space-y-6"><div class="bg-white p-6 rounded-xl shadow-md border space-y-4 ${isPastPrize ? 'opacity-50' : ''}"><div id="draw-message" class="flex justify-center items-center"></div><div id="countdown-timer" class="grid grid-cols-4 gap-2 text-center">${['days', 'hours', 'minutes', 'seconds'].map((l, i) => `<div id="${l}-unit" class="flex flex-col items-center digit-card"><div class="w-full aspect-[2/1] relative digit-card-inner"><div class="digit-card-face front-face text-xl font-bold" data-value="00">00</div><div class="digit-card-face back-face text-xl font-bold" data-value="00">00</div></div><span class="mt-1 text-xs uppercase">${['Days', 'Hrs', 'Min', 'Sec'][i]}</span></div>`).join('')}</div><div class="mt-4"><div class="w-full bg-gray-200 rounded-full h-3"><div id="prize-progress-bar" class="bg-accent h-3 rounded-full transition-all duration-500" style="width:${((prize.entries?.totalEntries || 0) / (prize.entries?.maxEntries || 1) * 100).toFixed(2)}%"></div></div>                <p class="text-xs text-center mt-2"><b id="prize-sold-entries">${((prize.entries?.totalEntries || 0) + selectedEntryOption).toLocaleString()}</b> of <span id="prize-max-entries">${(prize.entries?.maxEntries || 1).toLocaleString()}</span> sold</p></div></div>${!isPastPrize ? `<div class="space-y-4"><h3>Select Entries:</h3><div id="entry-options-container" class="grid grid-cols-5 gap-3">${entryButtons}</div><div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center"><span class="font-semibold">Total:</span><span id="entry-total" class="text-3xl font-extrabold text-accent">$${(selectedEntryOption * entryPrice).toLocaleString()}</span></div><button type="button" onclick="handleEntryPurchase('${prize.name}', ${entryPrice}, false)" class="w-full bg-accent hover:bg-accent-dark text-white font-extrabold py-4 rounded-lg">ENTER NOW</button><p class="text-xs text-center flex items-center justify-center"><i data-lucide="lock" class="w-4 mr-1"></i>100% Secure Checkout</p></div>` : `<div class="p-6 bg-red-50 rounded-xl border border-red-300"><p class="text-center font-bold text-red-700">This sweepstake is closed.</p></div>`}</div></div></div>`;
            mainContentEl.innerHTML = html;

            // Store current prize ID for real-time updates
            if (prize._id) {
                window.currentPrizeId = prize._id;
            }

            if (!isPastPrize && prize.drawTimestamp) {
                window.selectEntryOption(selectedEntryOption, null);
                startCountdown(new Date(prize.drawTimestamp).getTime());
            }
            lucide.createIcons();
        }

        // Function to update prize progress bar in real-time
        window.updatePrizeProgressBar = function (prizeId, entriesAdded) {
            // Only update if we're on the prize detail page and it's the current prize
            if (window.currentPage !== 'detail' || !window.currentPrizeId) {
                // Try to match by prize name if ID doesn't match
                const currentPrize = (window.PRIZES || []).find(p => p._id === window.currentPrizeId);
                if (!currentPrize) return;
            }

            // Find the prize in window.PRIZES and update it
            // Try to match by ID first, then by name
            let prize = null;
            let prizeIndex = -1;

            if (prizeId) {
                prizeIndex = (window.PRIZES || []).findIndex(p => String(p._id) === String(prizeId) || String(p.id) === String(prizeId));
            }

            // If not found by ID, try to find by current prize ID
            if (prizeIndex === -1 && window.currentPrizeId) {
                prizeIndex = (window.PRIZES || []).findIndex(p => String(p._id) === String(window.currentPrizeId) || String(p.id) === String(window.currentPrizeId));
            }

            if (prizeIndex !== -1) {
                prize = window.PRIZES[prizeIndex];
            }

            if (prize && prize.entries) {
                prize.entries.totalEntries = (prize.entries.totalEntries || 0) + entriesAdded;

                // Update the progress bar
                const progressBar = document.getElementById('prize-progress-bar');
                const soldEntriesEl = document.getElementById('prize-sold-entries');
                const maxEntries = prize.entries.maxEntries || 1;
                const totalEntries = prize.entries.totalEntries || 0;

                if (progressBar) {
                    const percentage = Math.min((totalEntries / maxEntries) * 100, 100);
                    progressBar.style.width = percentage.toFixed(2) + '%';
                }

                if (soldEntriesEl) {
                    soldEntriesEl.textContent = totalEntries.toLocaleString();
                }

                console.log('[Prize Progress] Updated:', totalEntries, 'of', maxEntries, 'sold (+' + entriesAdded + ')');
            } else {
                console.log('[Prize Progress] Prize not found for update. PrizeId:', prizeId, 'CurrentPrizeId:', window.currentPrizeId);
            }
        };
        function renderAllPrizesPage() {
            if (currentInterval) clearInterval(currentInterval);

            if ((window.PRIZES || []).length === 0 && (window.PAST_PRIZES || []).length === 0) {
                mainContentEl.innerHTML = `<div class="text-center py-12"><p class="text-gray-500">No prizes available</p></div>`;
                return;
            }

            // Filter valid prizes and combine active and past prizes
            const validPrizes = (p) => p && p._id && p.name && p.shortDescription;
            const prizesList = [
                ...(window.PRIZES || []).filter(validPrizes).map(p => ({ ...p, past: false })),
                ...(window.PAST_PRIZES || []).filter(validPrizes).map(p => ({ ...p, past: true }))
            ];

            if (prizesList.length === 0) {
                mainContentEl.innerHTML = `<div class="text-center py-12"><p class="text-gray-500">No valid prizes available</p></div>`;
                return;
            }

            const FALLBACK_IMAGE = 'https://placehold.co/300x200?text=No+Image';
            const html = `<h1 class="text-4xl font-extrabold pb-8 border-b">All Prizes</h1><div class="grid grid-cols-2 md:grid-cols-4 gap-6 pt-8">${prizesList.map(p => {
                // Truncate short description to max 100 characters for listing display
                const shortDesc = p.shortDescription || '';
                const truncatedDesc = shortDesc.length > 100 ? shortDesc.substring(0, 100) + '...' : shortDesc;
                return `
                <div onclick="changePage('detail', '${p._id}', event)" class="bg-white rounded-xl overflow-hidden shadow-lg card-bg cursor-pointer hover:shadow-lg transition duration-300 relative flex flex-col ${p.past ? 'opacity-70' : ''}">
                    ${p.past ? '<div class=\"absolute top-2 right-2 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full font-bold z-10\">CLOSED</div>' : ''}
                    <img src="${p.thumbnail || FALLBACK_IMAGE}" alt="${p.name}" class="w-full h-52 object-cover" onerror="this.src='${FALLBACK_IMAGE}'" />
                    <div class="p-4 flex-1 flex flex-col justify-between space-y-1">
                        <h4 class="text-lg font-bold">${p.name}</h4>
                        <p class="text-xs text-gray-500">${truncatedDesc}</p>
                        <div class="flex items-end justify-between pt-2">
                            <span class="text-lg font-bold text-accent">$${(p.entries?.entryPrice || 0).toLocaleString()}</span>
                            <button class="text-sm font-semibold px-3 py-1 rounded-lg ${p.past ? 'bg-gray-200 text-gray-400 cursor-default opacity-50' : 'bg-accent text-white hover:bg-accent-dark'}">${p.past ? 'View' : 'Enter'}</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('')}</div>`;
            mainContentEl.innerHTML = html;
        }
        function renderWinnersPage() {
            if (currentInterval) clearInterval(currentInterval);

            // Use the deduplicated winners from winners:list response (stored in window.TRANSACTIONS)
            // The backend already deduplicates by prize name, so we should trust that data
            // But we'll also deduplicate on the frontend as a safety measure

            // First, get winners from window.TRANSACTIONS (which is set by winners:list response)
            // These are already deduplicated by the backend, but let's ensure no duplicates here too
            const transactionsMap = new Map();
            (window.TRANSACTIONS || []).forEach(t => {
                if (t._id) {
                    const txId = String(t._id);
                    if (!transactionsMap.has(txId)) {
                        transactionsMap.set(txId, t);
                    }
                }
            });

            const allTransactions = Array.from(transactionsMap.values());
            const winnerTransactions = allTransactions.filter(t =>
                t.order?.isWinner === true && t.category === 'order' && t.order?.status === 'drawnWinner'
            );

            // Additional deduplication by prize name (backend should do this, but safety check)
            const winnersByPrize = new Map();
            winnerTransactions.forEach(t => {
                const prizeName = t.order?.prizeName;
                if (prizeName) {
                    // Keep only the most recent winner per prize
                    if (!winnersByPrize.has(prizeName)) {
                        winnersByPrize.set(prizeName, t);
                    } else {
                        const existing = winnersByPrize.get(prizeName);
                        const existingDate = new Date(existing.order?.dateTimestamp || existing.createdAt || 0);
                        const newDate = new Date(t.order?.dateTimestamp || t.createdAt || 0);
                        if (newDate > existingDate) {
                            winnersByPrize.set(prizeName, t);
                        }
                    }
                }
            });

            const uniqueWinnerTransactions = Array.from(winnersByPrize.values());

            console.log('[Winners] Total transactions:', (window.TRANSACTIONS || []).length);
            console.log('[Winners] Winner transactions (before dedup):', winnerTransactions.length);
            console.log('[Winners] Unique winner transactions (after dedup by prize):', uniqueWinnerTransactions.length);
            console.log('[Winners] Winner transactions details:', uniqueWinnerTransactions.map(t => ({
                transactionId: t._id,
                prizeName: t.order?.prizeName,
                prizeId: t.order?.prizeId,
                winnerName: t.user?.fullName || t.user?.name || t.order?.user?.fullName || t.order?.user?.name,
                isWinner: t.order?.isWinner,
                status: t.order?.status
            })));

            // Map winner transactions to winner objects with prize info
            const allWinners = uniqueWinnerTransactions.map(winnerTrx => {
                // Note: Transaction.order only has prizeName, not prizeId
                // So we need to find the prize by name
                const prizeNameFromTrx = winnerTrx.order?.prizeName;
                const prizeIdFromTrx = winnerTrx.order?.prizeId; // May not exist in old transactions

                // Try to find prize by name first (this is what we have in transactions)
                let prize = null;
                if (prizeNameFromTrx) {
                    prize = (window.PRIZES || []).find(p =>
                        p.name === prizeNameFromTrx || p.name?.toLowerCase() === prizeNameFromTrx?.toLowerCase()
                    );
                }

                // If not found in PRIZES, check PAST_PRIZES
                if (!prize && prizeNameFromTrx) {
                    prize = (window.PAST_PRIZES || []).find(p =>
                        p.name === prizeNameFromTrx || p.name?.toLowerCase() === prizeNameFromTrx?.toLowerCase()
                    );
                }

                // If we have a prizeId from transaction (newer transactions), try that too
                if (!prize && prizeIdFromTrx) {
                    prize = (window.PRIZES || []).find(p => {
                        const pId = String(p._id || p.id || '').toLowerCase();
                        const tId = String(prizeIdFromTrx || '').toLowerCase();
                        return pId === tId && pId !== '';
                    });
                    if (!prize) {
                        prize = (window.PAST_PRIZES || []).find(p => {
                            const pId = String(p._id || p.id || '').toLowerCase();
                            const tId = String(prizeIdFromTrx || '').toLowerCase();
                            return pId === tId && pId !== '';
                        });
                    }
                }

                // Use prize._id if found, otherwise we'll need to search by name when navigating
                const finalPrizeId = prize ? String(prize._id) : null;

                console.log('[Winners] Processing winner:', {
                    transactionPrizeName: prizeNameFromTrx,
                    transactionPrizeId: prizeIdFromTrx,
                    foundPrize: !!prize,
                    foundPrizeId: prize?._id,
                    finalPrizeId: finalPrizeId,
                    prizeName: prize?.name || prizeNameFromTrx
                });

                return {
                    prizeId: finalPrizeId, // Use prize._id if found
                    prizeName: prize?.name || prizeNameFromTrx || 'Unknown Prize',
                    prizeNameForLookup: prizeNameFromTrx, // Store name for fallback lookup
                    winnerName: winnerTrx.user?.fullName || winnerTrx.user?.name || winnerTrx.order?.user?.fullName || winnerTrx.order?.user?.name || 'Winner',
                    winnerImage: winnerTrx.user?.profileImage || winnerTrx.order?.user?.profileImage
                };
            });

            // Deduplicate allWinners - use a Set to track seen combinations
            // Key format: "prizeId|prizeName|winnerName" (normalized)
            const seenKeys = new Set();
            const uniqueWinners = [];

            allWinners.forEach(winner => {
                // Normalize all fields for comparison
                const normalizedPrizeId = winner.prizeId ? String(winner.prizeId).toLowerCase().trim() : '';
                const normalizedPrizeName = winner.prizeName ? String(winner.prizeName).toLowerCase().trim() : '';
                const normalizedWinnerName = winner.winnerName ? String(winner.winnerName).toLowerCase().trim() : '';

                // Create a unique key combining prize identifier and winner name
                // This ensures we catch exact duplicates
                const prizeKey = normalizedPrizeId || normalizedPrizeName || 'unknown-prize';
                const uniqueKey = `${prizeKey}|${normalizedWinnerName}`;

                if (!seenKeys.has(uniqueKey)) {
                    seenKeys.add(uniqueKey);
                    uniqueWinners.push(winner);
                } else {
                    console.log('[Winners] Skipping duplicate:', {
                        prizeId: winner.prizeId,
                        prizeName: winner.prizeName,
                        winnerName: winner.winnerName,
                        uniqueKey: uniqueKey
                    });
                }
            });

            // Also check legacy WINNERS array for backward compatibility
            // Only use legacy winners if we don't have transaction data, or if they're not already in our list
            const legacyWinners = (window.WINNERS || []).map(w => ({
                prizeId: w.prizeId,
                prizeName: w.prizeName,
                winnerName: w.winnerName || 'Anonymous',
                winnerImage: w.imageUrl
            }));

            // Only add legacy winners if we have transactions (they might be duplicates)
            // If we don't have transactions, use legacy winners
            if (uniqueWinnerTransactions.length === 0 && legacyWinners.length > 0) {
                console.log('[Winners] No transactions found, using legacy winners');
                legacyWinners.forEach(legacy => {
                    uniqueWinners.push(legacy);
                });
            } else if (uniqueWinnerTransactions.length > 0) {
                // We have transactions, only add legacy winners that aren't already in our list
                legacyWinners.forEach(legacy => {
                    // Normalize legacy winner fields
                    const normalizedLegacyPrizeId = legacy.prizeId ? String(legacy.prizeId).toLowerCase().trim() : '';
                    const normalizedLegacyPrizeName = legacy.prizeName ? String(legacy.prizeName).toLowerCase().trim() : '';
                    const normalizedLegacyWinnerName = legacy.winnerName ? String(legacy.winnerName).toLowerCase().trim() : '';

                    const legacyPrizeKey = normalizedLegacyPrizeId || normalizedLegacyPrizeName || 'unknown-prize';
                    const legacyUniqueKey = `${legacyPrizeKey}|${normalizedLegacyWinnerName}`;

                    if (!seenKeys.has(legacyUniqueKey)) {
                        seenKeys.add(legacyUniqueKey);
                        uniqueWinners.push(legacy);
                        console.log('[Winners] Adding legacy winner not in transactions:', legacy.winnerName);
                    } else {
                        console.log('[Winners] Skipping duplicate legacy winner (already in transactions):', {
                            prizeId: legacy.prizeId,
                            prizeName: legacy.prizeName,
                            winnerName: legacy.winnerName
                        });
                    }
                });
            }

            // Final deduplication pass - ensure absolutely no duplicates by prize name
            // This is the most important check - each prize should only have ONE winner
            const finalDedupMap = new Map();
            const finalWinners = [];

            uniqueWinners.forEach(winner => {
                // Use prize name as the primary key for deduplication (case-insensitive)
                // Prize name is more reliable than prizeId since transactions may not have prizeId
                const prizeName = (winner.prizeName || 'unknown').toLowerCase().trim();

                // If we already have a winner for this prize, skip this one
                if (!finalDedupMap.has(prizeName)) {
                    finalDedupMap.set(prizeName, winner);
                    finalWinners.push(winner);
                } else {
                    console.log('[Winners] Final deduplication - skipping duplicate winner for prize:', {
                        prizeId: winner.prizeId,
                        prizeName: winner.prizeName,
                        winnerName: winner.winnerName,
                        existingWinner: finalDedupMap.get(prizeName)?.winnerName
                    });
                }
            });

            console.log('[Winners] Before deduplication - allWinners:', allWinners.map(w => ({
                prizeId: w.prizeId,
                prizeName: w.prizeName,
                winnerName: w.winnerName
            })));

            console.log('[Winners] After deduplication:', {
                totalTransactions: (window.TRANSACTIONS || []).length,
                winnerTransactionsBeforeDedup: winnerTransactions.length,
                uniqueWinnerTransactions: uniqueWinnerTransactions.length,
                allWinnersCount: allWinners.length,
                uniqueWinners: uniqueWinners.length,
                legacyWinners: legacyWinners.length,
                finalWinners: finalWinners.length,
                finalWinnerPrizes: finalWinners.map(w => ({
                    prizeId: w.prizeId,
                    prizeName: w.prizeName,
                    winnerName: w.winnerName
                }))
            });

            if (finalWinners.length === 0) {
                mainContentEl.innerHTML = `<h1 class="text-4xl font-extrabold pb-8 border-b">Our Winners</h1><p class="text-gray-500 mb-8 max-w-2xl">Meet the people who have won big with Studentsweeps!</p><p class="text-center py-12 text-gray-400">No winners yet</p>`;
                return;
            }

            // Color palette for winner cards
            const colors = [
                '#8b5cf6', '#ef4444', '#10b981', '#000000', '#14b8a6',
                '#a16207', '#84cc16', '#3b82f6', '#15803d', '#7c3aed',
                '#991b1b', '#f97316', '#6366f1', '#059669', '#dc2626'
            ];

            // Generate initials from name
            const getInitials = (name) => {
                if (!name || name === 'Winner' || name === 'Anonymous') return 'W';
                const parts = name.trim().split(/\s+/);
                if (parts.length >= 2) {
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
            };

            const html = `
                <h1 class="text-4xl font-extrabold pb-8 border-b">Our Winners</h1>
                <p class="text-gray-500 mb-8 max-w-2xl">Meet the people who have won big with Studentsweeps!</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    ${finalWinners.map((w, idx) => {
                const initials = getInitials(w.winnerName);
                const bgColor = colors[idx % colors.length];
                // Make clickable if we have prizeId or prizeName (we can search by name)
                const clickTarget = w.prizeId || w.prizeNameForLookup || w.prizeName || '';
                const clickHandler = clickTarget ? `onclick="changePage('detail','${clickTarget}',event)"` : '';
                const cursorClass = clickTarget ? 'cursor-pointer' : 'cursor-default';
                return `
                            <div ${clickHandler}
                                 class="bg-white rounded-xl overflow-hidden ${cursorClass} shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                                 style="display: flex; flex-direction: column; height: 100%;">
                                <div style="background-color: ${bgColor}; height: 70%; display: flex; align-items: center; justify-content: center; position: relative; padding: 1rem;">
                                    <span style="color: white; font-size: 2.5rem; font-weight: bold; letter-spacing: 0.05em;">${initials}</span>
                                    <span style="position: absolute; top: 8px; right: 8px; background-color: #10b981; color: white; font-size: 0.625rem; font-weight: bold; padding: 4px 8px; border-radius: 9999px; display: flex; align-items: center; gap: 4px;">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5h3a2.5 2.5 0 0 1 0 5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5h-3a2.5 2.5 0 0 0 0 5H18"/><path d="M4 22h16"/><path d="M10 14V5"/><path d="M14 14V5"/><path d="M12 22v-8h-2.5l-.5 4"/><path d="M12 22v-8h2.5l.5 4"/></svg>
                                        WIN
                                    </span>
                                </div>
                                <div style="background-color: white; height: 30%; padding: 0.75rem; display: flex; flex-direction: column; justify-content: center;">
                                    <p style="font-size: 0.625rem; font-weight: bold; color: #10b981; text-transform: uppercase; margin: 0 0 4px 0; letter-spacing: 0.05em;">${w.prizeName}</p>
                                    <p style="font-size: 0.875rem; font-weight: 600; color: #111827; margin: 0;">${w.winnerName}</p>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
            mainContentEl.innerHTML = html;
            lucide.createIcons();
        }
        function renderDonationsPage() {
            if (currentInterval) clearInterval(currentInterval);

            if ((window.DONATIONS || []).length === 0) {
                mainContentEl.innerHTML = `<div class="text-center py-12"><p class="text-gray-500">No donations available</p></div>`;
                return;
            }

            // Calculate total raised from all donations
            const totalRaised = (window.DONATIONS || []).reduce((sum, d) => sum + (d.raised || 0), 0);

            const FALLBACK_DONATION_IMAGE = 'https://placehold.co/400x300?text=Donation';
            const html = `<h1 class="text-4xl font-extrabold pb-8 border-b">Charity & Donations</h1><p class="text-gray-500 mb-8 max-w-4xl">Your entries don't just win prizes, they change lives.</p><div class="grid sm:grid-cols-3 gap-6">${(window.DONATIONS || []).slice(0, 6).map(d => {
                const donationImage = d.image || '';
                return `<div onclick="changePage('donation_detail','${d._id}',event)" class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-accent cursor-pointer hover:shadow-xl transition">${donationImage ? `<img src="${donationImage}" alt="${d.name}" class="w-full h-40 object-cover rounded-lg" onerror="this.src='${FALLBACK_DONATION_IMAGE}'; this.onerror=null;" />` : `<div class="w-full h-40 bg-gradient-to-br from-blue-400 to-green-400 rounded-lg flex items-center justify-center"><i data-lucide="heart" class="w-12 h-12 text-white"></i></div>`}<h3 class="text-xl font-bold mt-3">${d.name}</h3><p class="text-sm text-gray-600">${d.shortDescription || ''}</p><button class="text-sm text-accent font-medium flex items-center mt-2">Read More <i data-lucide="arrow-right" class="w-4 ml-2"></i></button></div>`;
            }).join('')}</div><div class="mt-12 p-8 bg-gray-100 rounded-xl text-center"><h2 class="text-3xl font-bold">Total Impact</h2><p class="text-accent text-5xl font-extrabold timer-font">$${totalRaised.toLocaleString()}</p><p class="text-gray-500">Funded by the Studentsweeps Community.</p></div>`; mainContentEl.innerHTML = html; lucide.createIcons()
        }
        function renderDonationDetailPage(donationId) {
            const donation = (window.DONATIONS || []).find(d => d._id === donationId);
            if (!donation) { renderDonationsPage(); return; }
            // ensure the global currentDonationId is set for emits
            currentDonationId = donation._id;
            const progress = Math.min(100, ((donation.raised || 0) / (donation.goal || 1)) * 100);
            const suggested = 20;

            // Get the full description text
            const fullDescription = donation.content?.[0]?.value?.[0]?.description || donation.detail || 'Making a meaningful impact in our communities through direct action and support.';
            const descriptionId = `donation-desc-${donation._id}`;
            const maxLength = 250; // Character limit before showing "Read More"
            const isLongDescription = fullDescription.length > maxLength;
            const truncatedDescription = isLongDescription ? fullDescription.substring(0, maxLength) + '...' : fullDescription;

            const html = `
                <div class="max-w-4xl mx-auto space-y-10">
                    <button onclick="changePage('donations', null, event)" class="flex items-center text-accent hover:text-green-600 font-semibold mb-6">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to All Causes
                    </button>
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900">${donation.name}</h1>
                    <div class="grid md:grid-cols-5 gap-8">
                        <!-- Left --><div class="md:col-span-2 space-y-4">
                            ${donation.image ? `<img src="${donation.image}" alt="${donation.name}" class="w-full h-auto rounded-xl shadow-lg border border-gray-200 object-cover aspect-square" onerror="this.src='https://placehold.co/400x400?text=Donation'; this.onerror=null;" />` : `<div class="w-full h-auto bg-gradient-to-br from-blue-400 to-green-400 rounded-xl shadow-lg border border-gray-200 flex items-center justify-center aspect-square"><i data-lucide="heart" class="w-24 h-24 text-white"></i></div>`}
                            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                                <p class="text-xl font-bold text-gray-900">Goal: <span class="text-accent">$${(donation.goal || 0).toLocaleString()}</span></p>
                                <p class="text-sm text-gray-500 mb-3">Raised: $${(donation.raised || 0).toLocaleString()}</p>
                                <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-accent h-4 rounded-full" style="width: ${progress}%"></div></div>
                                <p class="text-center text-sm font-semibold mt-2">${progress.toFixed(0)}% Funded</p>
                            </div>

                            <div class="mt-4">
                                <label class="text-sm font-medium block mb-2">Donation amount (USD)</label>
                                <input id="donation-amount-input" type="number" min="1" value="${suggested}" class="w-full p-3 rounded-lg bg-gray-100 border border-gray-300" />
                            </div>

                            <button onclick="handleEntryPurchase('Donation for ${donation.name}', 1, true)" class="w-full bg-accent hover:bg-accent-dark text-white font-extrabold py-3 rounded-lg transition duration-200 shadow-md"> Donate Directly </button>
                        </div>

                        <!-- Right --><div class="md:col-span-3 space-y-6 text-gray-700">
                            <p class="text-lg font-semibold border-b pb-2 border-gray-100">${donation.shortDescription || ''}</p>
                            <div class="leading-relaxed text-gray-600">
                                <span id="${descriptionId}-short" ${isLongDescription ? '' : 'style="display: none;"'}>${truncatedDescription}</span>
                                <span id="${descriptionId}-full" ${isLongDescription ? 'style="display: none;"' : ''}>${fullDescription}</span>
                                ${isLongDescription ? `<button onclick="toggleDonationDescription('${descriptionId}')" id="${descriptionId}-btn" class="text-accent hover:text-green-600 font-semibold mt-2 inline-flex items-center">Read More <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i></button>` : ''}
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 border-b pb-1 border-gray-200">Impact Focus</h3>
                            <ul class="space-y-3">
                                <li><i data-lucide="shield-check" class="w-5 h-5 inline text-accent mr-3"></i> Direct community support and assistance.</li>
                                <li><i data-lucide="activity" class="w-5 h-5 inline text-accent mr-3"></i> Long-term sustainability and growth.</li>
                                <li><i data-lucide="school" class="w-5 h-5 inline text-accent mr-3"></i> Educational and developmental programs.</li>
                            </ul>
                            <div class="pt-4 border-t border-gray-200">
                                <h3 class="text-lg font-bold text-gray-900 mb-2">Our Partners:</h3>
                                <div class="flex space-x-4 text-sm text-gray-600"> ${(donation.partners || []).map(p => `<span class="px-3 py-1 bg-gray-100 rounded-full font-medium">${p}</span>`).join('') || '<span class="text-gray-400">No partners listed</span>'} </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            mainContentEl.innerHTML = html;
            lucide.createIcons();
        }

        function renderWinnersPage() {
            if (currentInterval) clearInterval(currentInterval);

            const winners = window.WINNERS || [];
            const FALLBACK_IMAGE = 'https://placehold.co/400x300?text=Winner';

            if (winners.length === 0) {
                mainContentEl.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="trophy" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-700 mb-2">No Winners Yet</h2>
                        <p class="text-gray-500">Winners will be displayed here once draws are completed.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const winnerCards = winners.map(winner => {
                const winnerImage = winner.imageUrl || FALLBACK_IMAGE;
                const winnerName = winner.winnerName || 'Anonymous Winner';
                const prizeName = winner.prizeName || 'Mystery Prize';
                // Handle both new format (prizeId) and old format (prize._id)
                let prizeId = winner.prizeId || '';
                if (!prizeId && winner.prize) {
                    prizeId = winner.prize._id || winner.prize.id || winner.prize;
                }
                // If still no prizeId, try to find prize by name
                if (!prizeId && prizeName) {
                    const matchingPrize = (window.PRIZES || []).find(p => p.name === prizeName);
                    if (matchingPrize) prizeId = matchingPrize._id;
                }
                const description = winner.description || '';
                const winDate = winner.winDate ? new Date(winner.winDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : '';

                // Only make clickable if we have a valid prizeId
                const clickHandler = prizeId ? `onclick="changePage('detail', '${prizeId}', event)"` : '';
                const cursorClass = prizeId ? 'cursor-pointer' : 'cursor-default';

                return `
                    <div ${clickHandler} class="bg-white rounded-xl overflow-hidden shadow-lg border border-gray-200 ${cursorClass} hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                        <div class="relative">
                            <img src="${winnerImage}" alt="${winnerName}" class="w-full h-46 object-cover" onerror="this.src='${FALLBACK_IMAGE}'" />
                            <div class="absolute top-3 right-3 bg-accent text-white px-3 py-1 rounded-full text-xs font-bold flex items-center">
                                <i data-lucide="trophy" class="w-4 h-4 mr-1"></i>
                                Winner
                            </div>
                        </div>
                        <div class="p-5">
                            <h3 class="text-lg font-bold text-gray-900 mb-1.5">${winnerName}</h3>
                            <p class="text-base font-semibold text-accent mb-1.5">${prizeName}</p>
                            ${description ? `<p class="text-sm text-gray-600 mb-2 line-clamp-2">${description}</p>` : ''}
                            ${winDate ? `<p class="text-xs text-gray-500 flex items-center">
                                <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
                                ${winDate}
                            </p>` : ''}
                            ${prizeId ? `
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <button class="text-accent hover:text-green-600 font-semibold text-sm flex items-center">
                                    View Prize Details
                                    <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <div class="space-y-8">
                    <div>
                        <h1 class="text-4xl font-extrabold pb-4 border-b border-gray-200">Our Winners</h1>
                        <p class="text-gray-500 mt-4 max-w-3xl">Celebrating the lucky winners who have made their dreams come true! Click on any winner card to see the prize details.</p>
                    </div>
                    
                    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10">
                        ${winnerCards}
                    </div>
                </div>
            `;

            mainContentEl.innerHTML = html;
            lucide.createIcons();
        }

        // Make renderWinnersPage globally accessible
        window.renderWinnersPage = renderWinnersPage;

        // Global changePage function for routing
        window.changePage = function (page, tab = null, event = null) {
            if (event) event.preventDefault();
            if (window.scrollTo) window.scrollTo(0, 0);

            currentPage = page;
            window.currentPage = page;

            if (page === 'home') {
                renderHomePage();
            } else if (page === 'prizes') {
                // Render prizes page (you may need to implement this)
                renderHomePage(); // Fallback for now
            } else if (page === 'donations') {
                renderDonationsPage();
            } else if (page === 'donation_detail') {
                renderDonationDetailPage(tab);
            } else if (page === 'detail') {
                renderPrizeDetailPage(tab);
            } else if (page === 'winners') {
                renderWinnersPage();
            } else if (page === 'profile') {
                currentProfileTab = tab || 'overview';
                renderProfilePage();
            } else if (page === 'about') {
                renderAboutUsPage();
            } else if (page === 'partners') {
                renderPartnersPage();
            } else {
                renderHomePage();
            }

            // Update header navigation
            renderHeader();
        };

        // Toggle donation description read more/less
        window.toggleDonationDescription = function (descriptionId) {
            const shortEl = document.getElementById(descriptionId + '-short');
            const fullEl = document.getElementById(descriptionId + '-full');
            const btnEl = document.getElementById(descriptionId + '-btn');

            if (!shortEl || !fullEl || !btnEl) return;

            const isExpanded = fullEl.style.display !== 'none';

            if (isExpanded) {
                // Collapse
                shortEl.style.display = '';
                fullEl.style.display = 'none';
                btnEl.innerHTML = 'Read More <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>';
            } else {
                // Expand
                shortEl.style.display = 'none';
                fullEl.style.display = '';
                btnEl.innerHTML = 'Read Less <i data-lucide="chevron-up" class="w-4 h-4 ml-1"></i>';
            }

            lucide.createIcons();
        };

        function renderPartnersPage() { if (currentInterval) clearInterval(currentInterval); const MOCK_PARTNERS = [{ name: 'Luxury Auto Group', logo: 'L.A.G', type: 'Prize Sourcing', description: 'Our primary partner for acquiring and certifying all high-value vehicles, ensuring pristine condition and authenticity.' }, { name: 'Global Youth Foundation', logo: 'GYF', type: 'Charity Partner', description: 'Dedicated to funding education and welfare programs for underprivileged youths around the world.' }, { name: 'Tech Sphere', logo: 'T.S.', type: 'Technology Provider', description: 'Provides the secure, audited platform for random draw generation and transactional security.' }, { name: 'Watches of Distinction', logo: 'W.D.', type: 'Jewellery Sourcing', description: 'Guarantees authenticity and provenance for all high-end timepieces and jewellery prizes.' },]; const html = ` <h1 class="text-4xl font-extrabold pb-4 border-b border-gray-200">Our Trusted Partners</h1> <div class="py-8 space-y-12"> <p class="text-gray-500 max-w-3xl"> We collaborate with world-class organizations to ensure the quality of our prizes, the security of our draws, and the integrity of our charitable contributions. </p> <div class="grid md:grid-cols-2 gap-8"> ${MOCK_PARTNERS.map(p => ` <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex items-start space-x-4"> <div class="w-16 h-12 sm:w-20 sm:h-14 rounded-lg flex items-center justify-center bg-gray-100 flex-shrink-0 border border-gray-300"> <span class="font-bold text-lg text-accent">${p.logo}</span> </div> <div> <h3 class="text-xl font-bold text-gray-900 mb-1">${p.name}</h3> <p class="text-sm font-semibold text-gray-500 mb-2">${p.type}</p> <p class="text-sm text-gray-700">${p.description}</p> </div> </div> `).join('')} </div> <section class="pt-8 border-t border-gray-200"> <h2 class="text-3xl font-bold mb-4">Charity Commitment</h2> <p class="text-gray-700 leading-relaxed max-w-4xl"> Our commitment to charity is independently verified by a third-party auditor. For every draw, we partner with reputable organizations to ensure maximum impact. </p> </section> </div> `; mainContentEl.innerHTML = html; }
        function renderAboutUsPage() { if (currentInterval) clearInterval(currentInterval); const html = ` <h1 class="text-4xl font-extrabold pb-4 border-b border-gray-200">About Studentsweeps.</h1> <div class="grid lg:grid-cols-3 gap-8 pt-8"> <div class="lg:col-span-2 space-y-6 text-gray-700"> <section> <h2 class="text-3xl font-bold mb-3 text-accent">Our Mission</h2> <p class="leading-relaxed"> Studentsweeps was founded on a simple, yet powerful idea: to turn dreams into reality while making a tangible positive impact on the world. We combine the excitement of winning highly sought-after, luxury prizes with a commitment to **social good**. Every entry purchased contributes directly to our featured non-profit partners, ensuring that your participation changes lives. </p> </section> <section> <h2 class="text-3xl font-bold mb-3 text-accent">Transparency & Fairness</h2> <p class="leading-relaxed"> Integrity is at the core of everything we do. All our draws are conducted under strict regulatory oversight, using **certified random number generation algorithms** to ensure every entry has an equal and fair chance of winning. We publish full details of our previous winners and provide clear, verifiable records of all donations made. </p> </section> </div> <div class="lg:col-span-1"> <div class="bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200 space-y-4"> <h3 class="text-xl font-bold text-gray-900">Join the Movement</h3> <p class="text-sm text-gray-500">Sign up for our newsletter to track our latest prizes and see the impact of your entries.</p> <form onsubmit="handleNewsletterSubmit(event)"> <input type="email" placeholder="Email Address" class="w-full p-3 mb-2 rounded-lg bg-white text-gray-900 border border-gray-300"> <button type="submit" class="w-full bg-accent hover:bg-accent-dark text-white font-semibold py-2 rounded-lg transition">Subscribe</button> </form> </div> </div> </div> `; mainContentEl.innerHTML = html; }

        // --- Core Application & Auth Logic ---
        const authModal = document.getElementById('auth-modal');
        const txModal = document.getElementById('transaction-modal');
        const authViews = { login: document.getElementById('login-view'), signup: document.getElementById('signup-view'), 'forgot-password': document.getElementById('forgot-password-view') };

        function renderHeader() {
            const authContainer = document.getElementById('auth-container');
            if (!authContainer) return;

            if (isLoggedIn && currentUser) {
                // normalize user fields to avoid 'undefined' appearing in the UI
                const _cu = currentUser || {};
                const displayName = _cu.name || _cu.fullName || _cu.full_name || ((_cu.firstName || _cu.first_name) && (_cu.lastName || _cu.last_name) ? `${_cu.firstName || _cu.first_name} ${_cu.lastName || _cu.last_name}` : null) || _cu.email || 'User';
                const initials = (displayName || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                // Prefer normalized `profileImage` field from SocketClient.normUser
                const FALLBACK_IMAGE = 'https://placehold.co/300x200?text=No+Image';
                const profileImage = _cu.profileImage || _cu.profileImageUrl || _cu.profile_image || '';
                const hasPfp = profileImage && profileImage !== 'null' && profileImage !== 'undefined';

                authContainer.innerHTML = `
                    <button onclick="toggleProfileDropdown()" class="w-10 h-10 rounded-full bg-gray-200 text-gray-700 flex items-center justify-center font-bold text-lg focus:outline-none ring-2 ring-offset-2 ring-transparent hover:ring-accent transition">
                        <img id="header-pfp" src="${profileImage || FALLBACK_IMAGE}" class="w-full h-full rounded-full object-cover ${!hasPfp ? 'hidden' : ''}" onerror="this.src='${FALLBACK_IMAGE}'; this.classList.remove('hidden'); this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');"/>
                        <span id="header-initials" class="justify-center items-center font-bold text-lg ${hasPfp ? 'hidden' : 'flex'}">${initials}</span>
                    </button>
                    <div id="profile-dropdown" class="profile-dropdown absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl py-1 z-50 hidden origin-top-right ring-1 ring-black ring-opacity-5">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <p class="text-sm font-semibold text-gray-900">${displayName}</p>
                            <p class="text-sm text-gray-500 truncate">${_cu.email || ''}</p>
                        </div>
                        <div class="py-1">
                            <a href="#" onclick="changePage('profile', 'overview', event)" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="user" class="w-4 h-4 mr-2"></i>Profile</a>
                            <a href="#" onclick="changePage('profile', 'overview', event)" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="receipt" class="w-4 h-4 mr-2"></i>Transactions</a>
                             <a href="#" onclick="changePage('profile', 'settings', event)" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="settings" class="w-4 h-4 mr-2"></i>Settings</a>
                            <a href="#" onclick="handleSupportClick(event)" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>Support</a>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <a href="#" onclick="handleLogout(event)" class="flex items-center w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i>Logout</a>
                    </div>
                `;
                lucide.createIcons();
            } else {
                authContainer.innerHTML = `<button onclick="openAuthModal()" class="bg-accent hover:bg-accent-dark text-white font-semibold py-2 px-5 rounded-lg">Sign In</button>`;
            }
        }
        function toggleProfileDropdown() { document.getElementById('profile-dropdown')?.classList.toggle('hidden'); }
        function openAuthModal() { authModal.classList.remove('is-hidden'); authModal.classList.add('is-visible'); switchAuthView('login'); }
        function closeAuthModal() { authModal.classList.add('is-hidden'); authModal.classList.remove('is-visible'); }
        function openTransactionModal() { txModal.classList.remove('is-hidden'); txModal.classList.add('is-visible'); }
        function closeTransactionModal() { txModal.classList.add('is-hidden'); txModal.classList.remove('is-visible'); }
        function switchAuthView(view, event) { if (event) event.preventDefault(); Object.values(authViews).forEach(v => v.classList.add('hidden')); if (authViews[view]) { authViews[view].classList.remove('hidden'); } }
        function showMessage(text) {
            Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: text, showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }, customClass: { popup: 'swal2-popup-custom' } });
        }

        // Expose globally for socket client
        window.showMessage = showMessage;
        window.closeCheckoutModal = closeCheckoutModal;

        function showTheme(accentColor, primaryBg, primaryText, borderColor) {
            // Resolve fallbacks in order: explicit args -> server settings -> CSS variable -> hardcoded safe default
            const cssAccent = (getComputedStyle(document.documentElement).getPropertyValue('--accent-color') || '').trim() || '#00C853';
            const serverColor = (window.APP_SETTINGS && window.APP_SETTINGS.primaryColor) ? window.APP_SETTINGS : {};

            accentColor = accentColor || serverColor.primaryColor || cssAccent;
            // Compute a slightly darker accent color for hover (simple HSL darken)
            function darken(hex, amt = 0.15) {
                let c = hex.replace('#', '');
                if (c.length === 3) c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2];
                let num = parseInt(c, 16);
                let r = Math.max(0, (num >> 16) - 255 * amt);
                let g = Math.max(0, ((num >> 8) & 0x00FF) - 255 * amt);
                let b = Math.max(0, (num & 0x0000FF) - 255 * amt);
                return `#${(1 << 24 | (r << 16) | (g << 8) | b).toString(16).slice(1)}`;
            }
            document.documentElement.style.setProperty('--accent-color-dark', darken(accentColor, 0.15));
            primaryBg = primaryBg || '#ffffff';
            primaryText = primaryText || '#1f2937';
            borderColor = borderColor || '#e5e7eb';

            document.documentElement.style.setProperty('--accent-color', accentColor);
            document.documentElement.style.setProperty('--bg-primary', primaryBg);
            document.documentElement.style.setProperty('--text-primary', primaryText);
            document.documentElement.style.setProperty('--border-color', borderColor);
            document.body.style.backgroundColor = primaryBg;
            document.body.style.color = primaryText;
        }

        function applyTheme() {
            if (!window.APP_SETTINGS || !window.APP_SETTINGS.primaryColor) return;
            const color = window.APP_SETTINGS;
            // Pass primaryColor through; showTheme will handle sensible fallbacks
            showTheme(color.primaryColor);
            try { lucide.createIcons(); } catch (e) { }
        }

        // Helper: change accent color locally and request server update if authenticated as admin
        window.setAccentColor = function (hex) {
            if (!hex) return;
            if (!hex.startsWith('#')) hex = `#${hex}`;
            // Apply locally immediately
            showTheme(hex);
            // If SocketClient is available and token present, emit settings:update to persist
            try {
                if (window.SocketClient && typeof window.SocketClient.getToken === 'function') {
                    const t = window.SocketClient.getToken();
                    const updates = { theme: { accentColor: hex } };
                    if (t) {
                        console.log('[APP] Emitting settings:update to server with', updates);
                        window.SocketClient.emit('settings:update', { updates });
                        return;
                    }
                }
            } catch (e) {
                console.warn('Failed to emit settings:update:', e);
            }
            console.log('[APP] Accent color applied locally only:', hex);
        };

        function hideLoading() { const ls = document.getElementById('loading-screen'); if (ls) { ls.style.opacity = '0'; ls.style.visibility = 'hidden'; setTimeout(() => ls.remove(), 300); } }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!window.SocketClient) { showMessage('Unable to connect'); return; }
            showMessage('Signing in...');
            window.SocketClient.emit('auth:login', { emailAddress: email, password });
        }

        function handleSignup(event) {
            event.preventDefault();
            const fullName = document.getElementById('signup-fullname')?.value || '';
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (!window.SocketClient) { showMessage('Unable to connect'); return; }
            showMessage('Creating account...');
            window.SocketClient.emit('auth:signup', { fullName, emailAddress: email, password });
        }

        function handleLogout(event) {
            event.preventDefault();
            window.SocketClient.clearToken();
            window.SocketClient.clearUser();
            isLoggedIn = false;
            currentUser = null;
            document.getElementById('profile-dropdown')?.classList.add('hidden');
            renderHeader();
            changePage('home');
            showMessage('Logged out');
        }

        function handleForgotPassword(event) { event.preventDefault(); closeAuthModal(); showMessage(`If an account exists, a reset link has been sent.`); }
        function handleSupportClick(event) { event.preventDefault(); toggleProfileDropdown(); showMessage(`For support, email us at <br><span class="font-semibold text-accent">support@studentsweeps.com</span>.`); }

        function handleEntryPurchase(itemName, itemPrice, isDonation = false, prizeId = null) {
            if (!isLoggedIn) { 
                showMessage(`Please sign in to purchase.`); 
                openAuthModal(); 
                return; 
            }

            // Ensure any existing checkout modal is closed first
            closeCheckoutModal();

            if (isDonation) {
                const amountInput = document.getElementById('donation-amount-input');
                if (!amountInput) {
                    if (currentDonationId) {
                        changePage('donation_detail', currentDonationId);
                        showMessage('Please enter a donation amount.');
                    } else {
                        showMessage('Please select a donation first.');
                    }
                    return;
                }
                const donationAmount = Number(amountInput.value || 0);
                if (isNaN(donationAmount) || donationAmount <= 0) {
                    showMessage('Please enter a valid donation amount.');
                    return;
                }
                openCheckoutModal(itemName, donationAmount, 1, false, currentDonationId);
            } else {
                // Use provided prizeId or fallback to currentPrizeId
                const finalPrizeId = prizeId || currentPrizeId;
                if (!finalPrizeId) {
                    console.warn('[handleEntryPurchase] No prizeId available');
                    showMessage('Unable to process purchase. Please try again.');
                    return;
                }
                openCheckoutModal(itemName, itemPrice, selectedEntryOption, true, finalPrizeId);
            }
        }

        // --- Checkout modal controls ---
        function resetCheckoutForm() {
            // Reset all form fields
            const billingForm = document.getElementById('billing-form');
            if (billingForm) {
                billingForm.reset();
            }
            
            // Reset individual fields explicitly
            const fields = [
                'billing-fullname',
                'billing-email',
                'billing-address1',
                'billing-address2',
                'billing-city',
                'billing-zip',
                'billing-country',
                'billing-state'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Reset save payment checkbox
            const saveCheckbox = document.getElementById('save-payment');
            if (saveCheckbox) {
                saveCheckbox.checked = false;
            }
        }

        function loadSavedBillingInfo() {
            try {
                // Auto-fill fullname and email from logged-in user
                if (currentUser) {
                    document.getElementById('billing-fullname').value = currentUser.fullName || '';
                    document.getElementById('billing-email').value = currentUser.emailAddress || '';
                }

                // Load other billing info from localStorage if saved
                const savedData = localStorage.getItem('sweepstackz_billing_info');
                if (savedData) {
                    const billingInfo = JSON.parse(savedData);
                    if (billingInfo.address1) document.getElementById('billing-address1').value = billingInfo.address1;
                    if (billingInfo.address2) document.getElementById('billing-address2').value = billingInfo.address2;
                    if (billingInfo.city) document.getElementById('billing-city').value = billingInfo.city;
                    if (billingInfo.zip) document.getElementById('billing-zip').value = billingInfo.zip;
                    if (billingInfo.country) document.getElementById('billing-country').value = billingInfo.country;
                    if (billingInfo.state) document.getElementById('billing-state').value = billingInfo.state;
                    // Pre-check the save checkbox if data was previously saved
                    document.getElementById('save-payment').checked = true;
                }
            } catch (e) {
                console.error('Error loading saved billing info:', e);
            }
        }

        function openCheckoutModal(itemName, itemPrice, quantity, isEntries, itemId) {
            // Clear any pending timeout from previous attempt
            if (window.pendingInvoiceTimeout) {
                clearTimeout(window.pendingInvoiceTimeout);
                window.pendingInvoiceTimeout = null;
                console.log('[Checkout] Cleared previous invoice timeout before opening modal');
            }
            
            // CRITICAL: Re-ensure socket connection and listeners when opening modal
            // This fixes the issue where user goes back from payment page and tries again
            if (window.SocketClient) {
                console.log('[Checkout] Verifying socket connection before opening modal...');
                const socketInstance = window.SocketClient._getSocket ? window.SocketClient._getSocket() : null;
                
                if (!socketInstance || !socketInstance.connected) {
                    console.log('[Checkout] Socket not connected, attempting to reconnect...');
                    if (window.SocketClient.init) {
                        window.SocketClient.init();
                        // Wait a moment for connection
                        setTimeout(() => {
                            if (window.SocketClient && window.SocketClient.ensurePurchaseListeners) {
                                window.SocketClient.ensurePurchaseListeners();
                            }
                        }, 500);
                    }
                } else {
                    // Socket is connected, but ensure listeners are registered
                    console.log('[Checkout] Socket connected, ensuring purchase listeners are active...');
                    if (window.SocketClient.ensurePurchaseListeners) {
                        window.SocketClient.ensurePurchaseListeners();
                    }
                }
            }
            
            // Ensure modal is closed first to reset any state
            const modalEl = document.getElementById('checkout-modal');
            if (modalEl) {
                modalEl.classList.add('is-hidden');
                modalEl.classList.remove('is-visible');
            }
            
            // Reset form first to ensure clean state
            resetCheckoutForm();
            
            // Set fresh checkout state for this purchase attempt
            checkoutState = {
                itemName,
                itemPrice: Number(itemPrice || 0),
                quantity: Number(quantity || 0),
                isEntries,
                prizeId: isEntries ? itemId : null,
                donationId: !isEntries ? itemId : null
            };

            console.log('[Checkout] Opening checkout modal with fresh state:', checkoutState);

            // Load saved billing info (this will populate fields after reset)
            loadSavedBillingInfo();
            
            // Update order details
            const orderTitleEl = document.getElementById('checkout-order-title');
            if (orderTitleEl) orderTitleEl.textContent = itemName;
            
            const priceLabel = isEntries ? `per entry` : `per donation`;
            const orderPriceEl = document.getElementById('checkout-order-price');
            if (orderPriceEl) {
                orderPriceEl.innerHTML = `$${(checkoutState.itemPrice).toLocaleString()} <span class="text-xs text-gray-500">${priceLabel}</span>`;
            }

            const typeLabel = document.getElementById('checkout-order-type-label');
            const quantityLabel = document.getElementById('checkout-quantity-label');
            if (isEntries) {
                if (typeLabel) typeLabel.textContent = 'Winning Prize:';
                if (quantityLabel) quantityLabel.textContent = 'Entries Purchased:';
            } else {
                if (typeLabel) typeLabel.textContent = 'Donation Campaign:';
                if (quantityLabel) quantityLabel.textContent = 'Amount:';
            }

            updateCheckoutTotals();
            renderPaymentProviders();
            
            // Ensure modal is opened - use setTimeout to ensure DOM is ready
            setTimeout(() => {
            const el = document.getElementById('checkout-modal');
                if (el) {
                    el.classList.remove('is-hidden');
                    el.classList.add('is-visible');
                    // Force a reflow to ensure visibility
                    el.offsetHeight;
                } else {
                    console.error('[Checkout] Modal element not found!');
                }
            }, 10);
            
            lucide.createIcons();
        }

        window.renderPaymentProviders = function renderPaymentProviders() {
            const container = document.getElementById('payment-providers-container');
            if (!container) return;

            // Get enabled payment options from PAYMENT_OPTIONS
            let enabledProviders = (window.PAYMENT_OPTIONS || []).filter(p => p.enabled === true);

            // Build provider info map
            const providerInfo = {
                'nowpayments': { label: 'Nowpayments (Crypto)', symbol: '' },
                'malum': { label: 'Malum (Credit/Debit/Bank)', icon: 'credit-card' }
            };

            // If no enabled providers, show a message
            if (enabledProviders.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No payment providers available</p>';
                return;
            }

            // Sort providers: prefer 'malum' first if both are enabled (more common payment method)
            enabledProviders.sort((a, b) => {
                if (a.providerName === 'malum') return -1;
                if (b.providerName === 'malum') return 1;
                return 0;
            });

            // Render each enabled provider as a radio button
            container.innerHTML = enabledProviders.map((provider, idx) => {
                const info = providerInfo[provider.providerName] || {};
                const isFirst = idx === 0; // First one is selected by default
                const symbolOrIcon = info.icon
                    ? `<i data-lucide="${info.icon}" class="w-5 h-5"></i>`
                    : `<span class="font-extrabold text-lg">${info.symbol}</span>`;

                return `
                    <label class="payment-provider-label relative flex items-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-gray-400 hover:bg-gray-50 transition-all duration-200 ${isFirst ? 'provider-selected' : ''}">
                        <input type="radio" name="checkout-provider" value="${provider.providerName}" class="sr-only provider-radio" ${isFirst ? 'checked' : ''} required>
                        <div class="flex-grow flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="provider-indicator flex items-center justify-center w-6 h-6 rounded-full border-2 border-gray-300 transition-all duration-200">
                                    <div class="provider-dot w-2.5 h-2.5 rounded-full bg-white opacity-0 transition-opacity duration-200"></div>
                                </div>
                                <span class="provider-label text-sm font-semibold text-gray-700 transition-all duration-200">${info.label}</span>
                            </div>
                            <span class="provider-icon text-gray-400 transition-all duration-200">${symbolOrIcon}</span>
                        </div>
                        <div class="provider-check absolute top-2 right-2 opacity-0 transition-opacity duration-200">
                            <i data-lucide="check-circle" class="w-5 h-5 text-accent"></i>
                        </div>
                    </label>
                `;
            }).join('');

            // Add event listeners for radio button changes
            const radioButtons = container.querySelectorAll('.provider-radio');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    // Remove selected class from all labels
                    container.querySelectorAll('.payment-provider-label').forEach(label => {
                        label.classList.remove('provider-selected');
                    });
                    // Add selected class to checked label
                    if (this.checked) {
                        this.closest('.payment-provider-label').classList.add('provider-selected');
                    }
                });
            });

            // Recreate icons after rendering
            if (window.lucide) lucide.createIcons();
        }

        function closeCheckoutModal() {
            const el = document.getElementById('checkout-modal');
            if (el) {
                el.classList.add('is-hidden');
                el.classList.remove('is-visible');
            }
            
            // Clear any pending timeout
            if (window.pendingInvoiceTimeout) {
                clearTimeout(window.pendingInvoiceTimeout);
                window.pendingInvoiceTimeout = null;
                console.log('[Checkout] Cleared pending invoice timeout (modal closed)');
            }
            
            // Reset checkout state and form when closing
            checkoutState = {
                itemName: null,
                itemPrice: 0,
                quantity: 0,
                isEntries: false,
                prizeId: null,
                donationId: null
            };
            
            console.log('[Checkout] Modal closed, checkout state reset. Ready for next purchase attempt.');
            resetCheckoutForm();
        }

        function updateCheckoutTotals() {
            const subtotal = checkoutState.itemPrice * checkoutState.quantity;
            const formattedTotal = subtotal.toFixed(2);

            document.getElementById('checkout-order-entries').textContent = `${checkoutState.quantity}`;
            document.getElementById('checkout-order-subtotal').textContent = `$${formattedTotal}`;
            document.getElementById('checkout-order-total').textContent = `$${formattedTotal}`;
            document.getElementById('checkout-confirm-amount').textContent = `$${formattedTotal}`;
        }

        function finalizeCheckout() {
            if (!window.SocketClient) { showMessage('Unable to connect'); return; }
            if (!isLoggedIn || !currentUser) { showMessage('Please sign in'); openAuthModal(); return; }

            const billingFullName = document.getElementById('billing-fullname')?.value?.trim();
            const billingEmail = document.getElementById('billing-email')?.value?.trim();
            const billingAddress1 = document.getElementById('billing-address1')?.value?.trim();
            const billingAddress2 = document.getElementById('billing-address2')?.value?.trim();
            const billingCity = document.getElementById('billing-city')?.value?.trim();
            const billingZip = document.getElementById('billing-zip')?.value?.trim();
            const billingCountry = document.getElementById('billing-country')?.value?.trim();
            const billingState = document.getElementById('billing-state')?.value?.trim();

            if (!billingFullName || !billingEmail || !billingAddress1 || !billingCity || !billingZip || !billingCountry) {
                showMessage('Please fill in all required billing fields.');
                return;
            }

            // Save billing info if checkbox is checked (excluding fullName and email which come from user account)
            const saveBillingCheckbox = document.getElementById('save-payment');
            if (saveBillingCheckbox && saveBillingCheckbox.checked) {
                const billingInfo = {
                    address1: billingAddress1,
                    address2: billingAddress2,
                    city: billingCity,
                    zip: billingZip,
                    country: billingCountry,
                    state: billingState
                };
                localStorage.setItem('sweepstackz_billing_info', JSON.stringify(billingInfo));
            }

            const provider = document.querySelector('input[name="checkout-provider"]:checked')?.value || 'malum';
            const subtotal = checkoutState.itemPrice * checkoutState.quantity;

            // Verify socket connection before proceeding
            if (!window.SocketClient) {
                showMessage('Socket client not available. Please refresh the page.', 'error');
                console.error('[Checkout] SocketClient not available');
                return;
            }
            
            if (!window.SocketClient.isConnected || !window.SocketClient.isConnected()) {
                showMessage('Connection lost. Please refresh the page and try again.', 'error');
                console.error('[Checkout] Socket not connected. isConnected:', window.SocketClient.isConnected?.());
                return;
            }
            
            // Get socket instance to verify connection
            const socketInstance = window.SocketClient._getSocket ? window.SocketClient._getSocket() : null;
            if (socketInstance && !socketInstance.connected) {
                console.error('[Checkout] Socket instance exists but not connected. Socket ID:', socketInstance.id);
                showMessage('Connection lost. Attempting to reconnect...', 'error');
                if (window.SocketClient.init) {
                    window.SocketClient.init();
                }
                return;
            }
            
            console.log('[Checkout] Socket connection verified. Socket ID:', socketInstance?.id, 'Connected:', socketInstance?.connected);

            showMessage('Processing payment...');
            try {
                // Store checkout state values before clearing
                const isEntries = checkoutState.isEntries;
                const prizeId = checkoutState.prizeId;
                const donationId = checkoutState.donationId;
                const quantity = checkoutState.quantity;
                
                console.log('[Checkout] ========================================');
                console.log('[Checkout] Preparing to emit purchase event');
                console.log('[Checkout] Purchase details:', { isEntries, prizeId, donationId, quantity, provider, subtotal });
                
                // Double-check socket connection right before emitting
                const socketCheck = window.SocketClient._getSocket ? window.SocketClient._getSocket() : null;
                if (!socketCheck || !socketCheck.connected) {
                    console.error('[Checkout]  Socket connection lost right before emit!');
                    showMessage('Connection lost. Please try again.', 'error');
                    closeCheckoutModal();
                    return;
                }
                console.log('[Checkout] Socket verified ready. Socket ID:', socketCheck.id);
                
                // CRITICAL: One final check - ensure purchase listeners are registered right before emitting
                // This is the last chance to fix listener issues before sending the purchase request
                if (window.SocketClient && window.SocketClient.ensurePurchaseListeners) {
                    console.log('[Checkout] Final check - ensuring purchase listeners before emit...');
                    const listenersOk = window.SocketClient.ensurePurchaseListeners();
                    if (!listenersOk) {
                        console.error('[Checkout]  Failed to ensure purchase listeners! Cannot proceed.');
                        showMessage('Connection issue. Please try again.', 'error');
                        closeCheckoutModal();
                        return;
                    }
                    console.log('[Checkout]  Purchase listeners verified active');
                }
                
                if (isEntries) {
                    const payload = {
                        prizeId: prizeId,
                        amount: quantity,
                        totalCost: subtotal,
                        paymentProvider: provider,
                        user: {
                            id: currentUser._id,
                            emailAddress: currentUser.emailAddress
                        }
                    };
                    console.log('[Checkout] Emitting entries:purchase with payload:', payload);
                    const emitResult = window.SocketClient.emit('entries:purchase', payload);
                    console.log('[Checkout]  Entries purchase emit result:', emitResult);
                    
                    if (!emitResult) {
                        console.error('[Checkout]  Emit failed! Socket may not be connected.');
                        showMessage('Failed to send purchase request. Please check your connection and try again.', 'error');
                        closeCheckoutModal();
                        return;
                    }

                    // Store prize ID and entry amount for real-time update
                    if (prizeId) {
                        window.pendingEntryPurchase = {
                            prizeId: prizeId,
                            amount: quantity
                        };
                    }
                } else {
                    const payload = {
                        donationId: donationId,
                        amount: subtotal,
                        paymentProvider: provider,
                        user: {
                            id: currentUser._id,
                            emailAddress: currentUser.emailAddress
                        }
                    };
                    console.log('[Checkout] Emitting donation:purchase with payload:', payload);
                    const emitResult = window.SocketClient.emit('donation:purchase', payload);
                    console.log('[Checkout]  Donation purchase emit result:', emitResult);
                    
                    if (!emitResult) {
                        console.error('[Checkout]  Emit failed! Socket may not be connected.');
                        // Try to reconnect and retry once
                        const socketInstance = window.SocketClient._getSocket ? window.SocketClient._getSocket() : null;
                        if (socketInstance && socketInstance.disconnected) {
                            console.log('[Checkout] Attempting to reconnect and retry...');
                            socketInstance.connect();
                            // Wait a moment and retry
                            setTimeout(() => {
                                if (socketInstance.connected) {
                                    console.log('[Checkout] Retrying emit after reconnection...');
                                    const retryResult = window.SocketClient.emit('donation:purchase', payload);
                                    if (!retryResult) {
                                        showMessage('Failed to send purchase request. Please refresh the page and try again.', 'error');
                                        closeCheckoutModal();
                                    }
                                } else {
                                    showMessage('Connection lost. Please refresh the page and try again.', 'error');
                closeCheckoutModal();
                                }
                            }, 1000);
                            return; // Don't proceed with timeout setup if we're retrying
                        } else {
                            showMessage('Failed to send purchase request. Please check your connection and try again.', 'error');
                            closeCheckoutModal();
                            return;
                        }
                    }
                }
                
                console.log('[Checkout]  Purchase event emitted successfully. Waiting for invoice response...');
                console.log('[Checkout] ========================================');
                
                // Don't close modal immediately - wait for invoice response
                // The modal will be closed when we receive the invoice URL and redirect
                // But set a timeout to close it if no response comes
                const invoiceTimeout = setTimeout(async () => {
                    console.warn('[Checkout]  No invoice response received after 15 seconds ');
                    console.warn('[Checkout] Socket state:', {
                        hasSocketClient: !!window.SocketClient,
                        isConnected: window.SocketClient?.isConnected?.() || false,
                        socketConnected: window.SocketClient?._getSocket?.()?.connected || false,
                        socketId: window.SocketClient?._getSocket?.()?.id || 'N/A'
                    });
                    
                    // Try to check if there's a pending transaction with invoice URL
                    let foundInvoiceUrl = null;
                    if (window.SocketClient && window.SocketClient.requestMyTransactions) {
                        console.log('[Checkout] Requesting transactions to check for pending payment...');
                        
                        // Request transactions and wait for response
                        const checkTransaction = new Promise((resolve) => {
                            const originalHandler = window.SocketClient._transactionCheckHandler;
                            
                            // Set up a one-time listener for transaction response
                            const checkHandler = (data) => {
                                if (data && data.success && data.transactions && Array.isArray(data.transactions)) {
                                    // Find the most recent pending transaction
                                    const pendingTx = data.transactions.find(tx => 
                                        (tx.category === 'order' && tx.order?.status === 'pendingPayment' && !tx.order?.isPaid) ||
                                        (tx.category === 'donation' && !tx.donation?.isPaid)
                                    );
                                    
                                    if (pendingTx) {
                                        // Try to extract invoice URL
                                        if (pendingTx.order?.invoiceData) {
                                            const invoice = pendingTx.order.invoiceData;
                                            if (invoice.url) foundInvoiceUrl = invoice.url;
                                            else if (invoice.invoice_url) foundInvoiceUrl = invoice.invoice_url;
                                            else if (invoice.payment_url) foundInvoiceUrl = invoice.payment_url;
                                        } else if (pendingTx.donation?.invoiceData) {
                                            const invoice = pendingTx.donation.invoiceData;
                                            if (invoice.url) foundInvoiceUrl = invoice.url;
                                            else if (invoice.invoice_url) foundInvoiceUrl = invoice.invoice_url;
                                            else if (invoice.payment_url) foundInvoiceUrl = invoice.payment_url;
                                        }
                                        
                                        console.log('[Checkout] Found pending transaction:', pendingTx.trxID, 'Invoice URL:', foundInvoiceUrl);
                                    }
                                }
                                
                                // Restore original handler if it existed
                                if (originalHandler) {
                                    window.SocketClient._transactionCheckHandler = originalHandler;
                                } else {
                                    delete window.SocketClient._transactionCheckHandler;
                                }
                                
                                resolve(foundInvoiceUrl);
                            };
                            
                            window.SocketClient._transactionCheckHandler = checkHandler;
                            window.SocketClient.requestMyTransactions();
                            
                            // Timeout after 3 seconds
                            setTimeout(() => {
                                if (window.SocketClient._transactionCheckHandler === checkHandler) {
                                    delete window.SocketClient._transactionCheckHandler;
                                }
                                resolve(null);
                            }, 3000);
                        });
                        
                        foundInvoiceUrl = await checkTransaction;
                    }
                    
                    if (foundInvoiceUrl) {
                        console.log('[Checkout]  Found invoice URL from transaction check! Redirecting...');
                        if (window.pendingInvoiceTimeout) {
                            clearTimeout(window.pendingInvoiceTimeout);
                            window.pendingInvoiceTimeout = null;
                        }
                        if (typeof window.closeCheckoutModal === 'function') {
                            window.closeCheckoutModal();
                        }
                        if (window.showMessage) window.showMessage('Redirecting to payment...', 'success');
                        setTimeout(() => {
                            window.location.href = foundInvoiceUrl;
                        }, 100);
                    } else {
                        // Don't show timeout message - just keep waiting silently
                        // The invoice will come eventually or user can check transactions manually
                        console.log('[Checkout] No invoice URL found in transactions. Continuing to wait for socket event...');
                        // Keep modal open and continue waiting - don't show error message
                    }
                }, 30000); // Increased to 30 seconds to give more time
                
                // Store timeout ID so we can clear it when invoice is received
                window.pendingInvoiceTimeout = invoiceTimeout;
                console.log('[Checkout]  Invoice timeout set for 30 seconds');
                
                // Clear checkout state after emitting (but keep modal open until redirect)
                checkoutState = {
                    itemName: null,
                    itemPrice: 0,
                    quantity: 0,
                    isEntries: false,
                    prizeId: null,
                    donationId: null
                };
            } catch (e) {
                console.error('[Checkout] Purchase failed:', e);
                showMessage('Failed to process payment. Please try again.', 'error');
                closeCheckoutModal();
            }
        }

        window.selectEntryOption = (entries, event) => {
            if (event) event.preventDefault();

            // Get prize from current page context - use currentPrizeId which is set in renderPrizeDetailPage
            let prize = null;
            if (currentPrizeId) {
                prize = (window.PRIZES || []).find(p => p._id === currentPrizeId) || (window.PRIZES || []).find(p => p.id === currentPrizeId);
            }
            // If still no prize, try to find it from rendered buttons
            if (!prize && document.querySelector('.product-option-button')) {
                // We're on a prize detail page, find the prize by iterating PRIZES
                const allPrizes = [...(window.PRIZES || []), ...(window.PAST_PRIZES || [])];
                prize = allPrizes.length > 0 ? allPrizes[0] : null;
            }

            if (!prize) return;

            const entryPrice = prize.entries?.entryPrice ?? 0;
            selectedEntryOption = entries;
            
            // Update total price display
            const totalEl = document.getElementById('entry-total');
            if (totalEl) totalEl.textContent = `$${(entries * entryPrice).toLocaleString()}`;
            
            // Update sold entries display to show preview: current sold + selected entries
            const soldEntriesEl = document.getElementById('prize-sold-entries');
            if (soldEntriesEl) {
                const currentSold = prize.entries?.totalEntries || 0;
                const previewSold = currentSold + entries;
                soldEntriesEl.textContent = previewSold.toLocaleString();
            }

            // Update all button styles with Tailwind classes
            document.querySelectorAll('.product-option-button').forEach(btn => {
                const btnEntries = parseInt(btn.getAttribute('data-entries'));
                if (btnEntries === entries) {
                    btn.classList.add('active', 'bg-accent', 'text-white', 'border-accent');
                    btn.classList.remove('border', 'border-gray-300', 'hover:border-accent');
                } else {
                    btn.classList.remove('active', 'bg-accent', 'text-white', 'border-accent');
                    btn.classList.add('border', 'border-gray-300', 'hover:border-accent');
                }
            });
        }
        window.handleNewsletterSubmit = (event) => { event.preventDefault(); showMessage(`Thank you for subscribing!`); }

        // --- Navigation with Socket Refresh ---
        let isRendering = false;

        window.changePage = (page, tab = null, event) => {
            if (event) event.preventDefault();
            window.scrollTo(0, 0);

            currentPage = page;
            window.currentPage = page;  // Make accessible to SocketClient
            window.currentPrizeId = tab;  // Make accessible to SocketClient
            window.currentDonationId = tab;  // Make accessible to SocketClient
            if (page === 'detail' && tab) currentPrizeId = tab;
            if (page === 'donation_detail' && tab) currentDonationId = tab;
            if (page === 'profile') currentProfileTab = tab || 'overview';

            document.getElementById('profile-dropdown')?.classList.add('hidden');

            // Request data first
            if (window.SocketClient && window.SocketClient.isConnected()) {
                try {
                    // Request needed data based on page
                    // Always request prizes for detail page, and also for winners page (needed for winner cards)
                    if (['home', 'prizes', 'detail', 'winners'].includes(page)) window.SocketClient.emit('prizes:list', {});
                    if (['home', 'donations', 'donation_detail'].includes(page)) window.SocketClient.emit('donations:list', {});
                    if (page === 'profile' && currentUser) window.SocketClient.requestMyTransactions();
                    if (page === 'home') window.SocketClient.emit('draw:history', { limit: 50, skip: 0 });
                    if (['home', 'winners'].includes(page)) window.SocketClient.emit('winners:list', {});
                } catch (e) { console.warn('Socket failed:', e); }
            }

            // Render page with current data
            const pageRenderers = {
                home: renderHomePage,
                prizes: renderAllPrizesPage,
                winners: renderWinnersPage,
                donations: renderDonationsPage,
                donation_detail: () => renderDonationDetailPage(currentDonationId),
                partners: renderPartnersPage,
                about: renderAboutUsPage,
                detail: () => renderPrizeDetailPage(currentPrizeId),
                profile: renderProfilePage
            };

            // Render immediately with available data
            (pageRenderers[currentPage] || renderHomePage)();

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.nav-link[data-page="${currentPage.split('_')[0]}"]`);
            if (activeLink) activeLink.classList.add('active');
        };

        // --- Mobile Menu ---
        function openMobileMenu() {
            mobileMenu.classList.remove('hidden'); // Make it visible first
            mobileMenuOverlay.classList.remove('hidden');
            // Force reflow might not be needed if starting from hidden
            requestAnimationFrame(() => { // Use rAF for smoother transition start
                mobileMenu.classList.add('menu-open');
            });
        }
        function closeMobileMenu() {
            mobileMenu.classList.remove('menu-open'); // Start sliding out
            mobileMenuOverlay.classList.add('hidden'); // Hide overlay immediately
            // Add timeout to hide after transition (using event listener is more robust)
            mobileMenu.addEventListener('transitionend', function handler() {
                mobileMenu.classList.add('hidden'); // Hide after transition
                mobileMenu.removeEventListener('transitionend', handler); // Clean up listener
            }, { once: true });
        }
        function handleMobileNavClick(page, tab = null, event) {
            changePage(page, tab, event);
            closeMobileMenu();
        }

        // --- Profile Page & Transaction Modal Logic ---
        function switchProfileTab(tab, event) { if (event) event.preventDefault(); currentProfileTab = tab; renderProfilePage(); }
        function handleProfileUpdate(event) {
            event.preventDefault();
            if (!currentUser) { showMessage('Please sign in to update your profile.'); openAuthModal(); return; }

            // Read values from the settings form (map to real User model fields)
            const fullName = document.getElementById('settings-fullname')?.value?.trim() || currentUser.fullName || currentUser.name || '';
            const phoneNumber = document.getElementById('settings-phone')?.value?.trim() || '';
            const billingAddress = {
                street: document.getElementById('settings-street')?.value?.trim() || '',
                city: document.getElementById('settings-city')?.value?.trim() || '',
                state: document.getElementById('settings-state')?.value?.trim() || '',
                postalCode: document.getElementById('settings-postal')?.value?.trim() || '',
                country: document.getElementById('settings-country')?.value?.trim() || ''
            };
            const settings = {
                prizeAlert: !!document.getElementById('notif-newPrizes')?.checked,
                drawResults: !!document.getElementById('notif-drawResults')?.checked,
                newsLetter: !!document.getElementById('notif-newsletter')?.checked
            };

            // Show loading message
            showMessage('Updating profile...');

            const previousUser = { ...currentUser };
            const uid = currentUser?._id;
            if (window.SocketClient && uid) {
                const payload = {
                    userId: uid,
                    updates: {
                        fullName,
                        phoneNumber,
                        billingAddress,
                        settings
                    }
                };
                console.log('[Frontend] Emitting user:update with payload:', payload);
                window.SocketClient.emit('user:update', payload);

                // Listen for the response ONCE
                const handler = function (data) {
                    if (data && data.success && data.user) {
                        // Update local state only on success
                        currentUser = data.user;
                        window.currentUser = currentUser;
                        if (window.SocketClient) window.SocketClient.setUser(currentUser);
                        try { renderHeader(); renderProfilePage(); } catch (e) { }
                        showMessage('Profile updated!');
                    } else {
                        // Revert local changes on failure
                        currentUser = previousUser;
                        window.currentUser = currentUser;
                        if (window.SocketClient) window.SocketClient.setUser(currentUser);
                        try { renderHeader(); renderProfilePage(); } catch (e) { }
                        showMessage(data && data.message ? data.message : 'Profile update failed');
                    }
                    // Remove this handler after it runs
                    if (window.SocketClient && typeof window.SocketClient._getSocket === 'function') {
                        const sock = window.SocketClient._getSocket();
                        if (sock) sock.off('user:update:response', handler);
                    }
                };
                if (window.SocketClient && typeof window.SocketClient._getSocket === 'function') {
                    const sock = window.SocketClient._getSocket();
                    if (sock) sock.on('user:update:response', handler);
                }
            }
        }
        function handlePasswordUpdate(event) {
            event.preventDefault();
            const form = document.getElementById('password-form');
            if (!form) return;
            const pwFields = form.querySelectorAll('input[type="password"]');
            const currentPassword = pwFields[0]?.value?.trim() || '';
            const newPassword = pwFields[1]?.value?.trim() || '';
            const confirmPassword = pwFields[2]?.value?.trim() || '';

            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('Please fill in all password fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('New password must be at least 6 characters');
                return;
            }

            if (!window.SocketClient || !currentUser || !currentUser._id) {
                showMessage('Unable to connect');
                return;
            }

            // Use raw socket.io emit to support callback
            if (window.SocketClient && window.SocketClient._getSocket && typeof window.SocketClient._getSocket === 'function') {
                const sock = window.SocketClient._getSocket();
                if (sock && typeof sock.emit === 'function') {
                    sock.emit('user:changePassword', {
                        userId: currentUser._id,
                        currentPassword,
                        newPassword
                    }, function (response) {
                        if (response && response.success) {
                            showMessage('Password successfully changed!');
                            form.reset();
                        } else {
                            showMessage(response && response.message ? response.message : 'Password change failed');
                        }
                    });
                    return;
                }
            }
            // fallback: no callback support
            showMessage('Unable to connect to server');
        }

        function handleChangeProfilePicture() {
            if (!currentUser) return;
            if (!window.SocketClient) { showMessage('Unable to connect'); return; }

            // Generate a unique profile picture URL using the user's name/email
            const displayName = currentUser.fullName || currentUser.name || currentUser.emailAddress || 'User';
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const accent = (document.documentElement.style.getPropertyValue('--accent-color').trim() || '#00C853').replace('#', '');
            const newProfileImage = `https://placehold.co/100x100/${accent}/FFFFFF?text=${initials}`;

            // Update local state immediately
            currentUser.profileImage = newProfileImage;
            window.currentUser = currentUser;
            window.SocketClient.setUser(currentUser);

            // Emit update to backend
            const uid = currentUser?._id;
            if (uid) {
                const payload = {
                    userId: uid,
                    updates: {
                        profileImage: newProfileImage
                    }
                };
                window.SocketClient.emit('user:update', payload);
            }

            // Re-render UI
            renderHeader();
            renderProfilePage();
            showMessage("Profile picture updated!");
        }

        function handleViewTransaction(transactionId) {
            if (!transactionId) {
                console.warn('[View Transaction] No transaction ID provided');
                return;
            }
            const tx = (window.TRANSACTIONS || []).find(t => (t._id && String(t._id) === String(transactionId)) || (t.id && String(t.id) === String(transactionId)));
            if (!tx) {
                console.warn('[View Transaction] Transaction not found:', transactionId);
                showMessage('Transaction not found', 'error');
                return;
            }

            // Handle different transaction structures based on category
            const isDonation = tx.category === 'donation';
            const isOrder = tx.category === 'order';

            let txEntries = 0;
            let txCost = 0;
            let txTotal = 0;
            let txPrizeName = 'Transaction';
            let txStatus = tx.status || 'pending';
            let isPaid = false; // Track payment status

            if (isOrder && tx.order) {
                txEntries = tx.order.entries?.amount || 0;
                txCost = tx.order.entries?.costPerEntry || 0;
                txTotal = tx.order.entries?.totalCost || (txCost * txEntries);
                txPrizeName = tx.order.prizeName || 'Prize';
                txStatus = tx.order.status || txStatus;
                isPaid = tx.order.isPaid || false; // Check isPaid flag
            } else if (isDonation && tx.donation) {
                txEntries = 0;
                // First try the stored amount field, then fall back to invoice data
                txTotal = tx.donation.amount ||
                    tx.donation.invoiceData?.amount ||
                    tx.donation.invoiceData?.priceAmount ||
                    tx.invoiceData?.amount ||
                    tx.invoiceData?.priceAmount || 0;
                txPrizeName = tx.donation.name || 'Donation';
                txCost = txTotal;
                isPaid = tx.donation.isPaid || false; // Check isPaid flag
            } else {
                // Fallback to old format
                txEntries = tx.entries || (tx.isDonation ? 0 : 1);
                txCost = tx.cost || 0;
                txTotal = txCost * txEntries;
                txPrizeName = tx.prizeName || tx.donationName || tx.prize?.name || tx.donation?.name || 'Transaction';
                txStatus = tx.status || txStatus;
            }

            const startNum = txEntries > 0 ? Math.floor(Math.random() * Math.max(1, 15000 - txEntries)) : 0;
            const endNum = startNum + txEntries - 1;

            // Status configuration - prioritize isPaid flag for accurate display
            let statusConfig = { color: 'bg-gray-400', icon: 'circle', label: txStatus };
            let displayStatus = txStatus;

            // If payment is completed, show "Paid" status (green)
            if (isPaid && (txStatus === 'active' || txStatus === 'pendingPayment')) {
                statusConfig = { color: 'bg-green-500', icon: 'check-circle', label: 'Paid' };
                displayStatus = 'Paid';
            } else if (txStatus === 'active' || txStatus === 'pendingPayment') {
                statusConfig = { color: 'bg-blue-500', icon: 'hourglass', label: 'Pending Payment' };
                displayStatus = 'Pending Payment';
            } else if (txStatus === 'drawn') {
                statusConfig = { color: 'bg-yellow-500', icon: 'check', label: 'Drawn' };
                displayStatus = 'Drawn';
            } else if (txStatus === 'winner' || txStatus === 'drawnWinner' || (txStatus && txStatus.includes('Winner'))) {
                statusConfig = { color: 'bg-green-500', icon: 'trophy', label: 'Winner' };
                displayStatus = 'Winner';
            } else if (txStatus === 'completed' || (isDonation && isPaid)) {
                statusConfig = { color: 'bg-purple-500', icon: 'heart', label: 'Completed' };
                displayStatus = isDonation ? 'Completed' : 'Completed';
            }

            const txId = tx._id || tx.id || 'N/A';
            const txDate = new Date(tx.createdAt || tx.date || tx.order?.dateTimestamp || tx.donation?.dateTimestamp || Date.now()).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

            document.getElementById('tx-id').textContent = `ID: ${txId}`;
            document.getElementById('tx-prize').textContent = txPrizeName;
            document.getElementById('tx-date').textContent = txDate;
            document.getElementById('tx-status').innerHTML = `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium text-white ${statusConfig.color}"><i data-lucide="${statusConfig.icon}" class="w-3 h-3 mr-1.5"></i> ${displayStatus}</span>`;
            document.getElementById('tx-entries').textContent = isDonation ? 'N/A' : txEntries.toLocaleString();
            document.getElementById('tx-cost').textContent = isDonation ? 'N/A' : `$${txCost.toLocaleString()}`;
            document.getElementById('tx-total').textContent = `$${txTotal.toLocaleString()}`;
            document.getElementById('tx-entry-numbers').textContent = isDonation ? 'N/A (Donation)' : `#${startNum} - #${endNum}`;

            openTransactionModal();
            lucide.createIcons();
        }

        function renderProfilePage() {
            if (currentInterval) clearInterval(currentInterval);
            if (!isLoggedIn || !currentUser) { changePage('home'); openAuthModal(); return; }

            // Only request transactions if they haven't been loaded yet and we're not already loading
            // Don't request on every render to avoid infinite loops
            if ((!window.TRANSACTIONS || window.TRANSACTIONS.length === 0) &&
                !window.TRANSACTIONS_LOADING &&
                window.SocketClient &&
                window.SocketClient.requestMyTransactions) {
                window.TRANSACTIONS_LOADING = true;
                window.SocketClient.requestMyTransactions();
                // Don't return early - render with empty transactions, will update when loaded
            }

            // Normalized user display fields
            const _cu = currentUser || {};
            const displayName = _cu.fullName || _cu.name || _cu.email || 'User';
            const displayEmail = _cu.emailAddress || _cu.email || '';
            // Use normalized field name from SocketClient.normUser
            const FALLBACK_IMAGE = 'https://placehold.co/300x200?text=No+Image';
            const displayPfp = _cu.profileImage || _cu.profileImageUrl || _cu.profile_image || FALLBACK_IMAGE;
            const memberSince = _cu.createdAt || _cu.memberSince || Date.now();
            const notifications = _cu.settings || {};

            // User stats from backend (or calculated from transactions)
            const transactions = window.TRANSACTIONS || [];
            console.log('[Profile] Calculating stats from', transactions.length, 'transactions');

            // Debug: Log first transaction structure
            if (transactions.length > 0) {
                console.log('[Profile] Sample transaction structure:', {
                    category: transactions[0].category,
                    hasOrder: !!transactions[0].order,
                    hasDonation: !!transactions[0].donation,
                    orderEntries: transactions[0].order?.entries,
                    donationAmount: transactions[0].donation?.amount
                });
            }

            const calculateTotalSpent = () => {
                try {
                    let total = 0;
                    transactions.forEach((tx, index) => {
                        try {
                            let amount = 0;
                            if (tx.category === 'order' && tx.order?.entries) {
                                amount = parseFloat(tx.order.entries.totalCost) || 0;
                                if (amount > 0) console.log(`[Profile] Order ${index}: $${amount}`);
                            } else if (tx.category === 'donation' && tx.donation) {
                                // First try the stored amount field, then fall back to invoice data
                                amount = parseFloat(tx.donation.amount) ||
                                    parseFloat(tx.donation.invoiceData?.price_amount) ||
                                    parseFloat(tx.donation.invoiceData?.priceAmount) ||
                                    parseFloat(tx.donation.invoiceData?.amount) ||
                                    parseFloat(tx.invoiceData?.price_amount) ||
                                    parseFloat(tx.invoiceData?.priceAmount) ||
                                    parseFloat(tx.invoiceData?.amount) || 0;
                                if (amount > 0) console.log(`[Profile] Donation ${index}: $${amount}`);
                            } else {
                                // Fallback for old format
                                const cost = parseFloat(tx.cost) || 0;
                                const entries = parseFloat(tx.entries) || 1;
                                amount = cost * entries;
                                if (amount > 0) console.log(`[Profile] Old format ${index}: $${amount}`);
                            }
                            total += amount;
                        } catch (e) {
                            console.warn('[Profile] Error calculating cost for transaction:', tx._id || tx.id, e);
                        }
                    });
                    console.log('[Profile] Total spent calculated:', total);
                    return total;
                } catch (e) {
                    console.error('[Profile] Error in calculateTotalSpent:', e);
                    return 0;
                }
            };

            const calculateTotalEntries = () => {
                try {
                    let total = 0;
                    transactions.forEach((tx, index) => {
                        try {
                            let entries = 0;
                            if (tx.category === 'order' && tx.order?.entries) {
                                entries = parseFloat(tx.order.entries.amount) || 0;
                                if (entries > 0) console.log(`[Profile] Order ${index}: ${entries} entries`);
                            } else if (tx.category !== 'donation') {
                                // Fallback for old format
                                entries = parseFloat(tx.entries) || 1;
                                if (entries > 0) console.log(`[Profile] Old format ${index}: ${entries} entries`);
                            }
                            total += entries;
                        } catch (e) {
                            console.warn('[Profile] Error calculating entries for transaction:', tx._id || tx.id, e);
                        }
                    });
                    console.log('[Profile] Total entries calculated:', total);
                    return total;
                } catch (e) {
                    console.error('[Profile] Error in calculateTotalEntries:', e);
                    return 0;
                }
            };

            const calculateTotalOrders = () => {
                try {
                    // Only count orders (not donations)
                    const orderCount = transactions.filter(tx => {
                        return tx.category === 'order' || (!tx.category && !tx.isDonation);
                    }).length;
                    console.log('[Profile] Total orders calculated:', orderCount);
                    return orderCount;
                } catch (e) {
                    console.error('[Profile] Error in calculateTotalOrders:', e);
                    return 0;
                }
            };

            const calculatePrizesWon = () => {
                try {
                    const wonCount = transactions.filter(tx => {
                        const status = tx.order?.status || tx.status || '';
                        return status === 'winner' || status === 'drawnWinner' || (status && status.includes('Winner'));
                    }).length;
                    console.log('[Profile] Prizes won calculated:', wonCount);
                    return wonCount;
                } catch (e) {
                    console.error('[Profile] Error in calculatePrizesWon:', e);
                    return 0;
                }
            };

            const userStats = _cu.stats || {
                totalOrders: calculateTotalOrders(),
                totalEntries: calculateTotalEntries(),
                totalSpent: calculateTotalSpent(),
                prizesWon: calculatePrizesWon()
            };

            console.log('[Profile] Calculated stats:', userStats);

            const transactionsHtml = (window.TRANSACTIONS || []).map(tx => {
                // Handle different transaction structures based on category
                const isDonation = tx.category === 'donation';
                const isOrder = tx.category === 'order';

                // Get transaction details based on category
                let txEntries = 0;
                let txCost = 0;
                let txTotal = 0;
                let txPrizeName = 'Transaction';
                let txStatus = tx.status || 'pending';
                let isPaid = false; // Track payment status

                if (isOrder && tx.order) {
                    txEntries = tx.order.entries?.amount || 0;
                    txCost = tx.order.entries?.costPerEntry || 0;
                    txTotal = tx.order.entries?.totalCost || (txCost * txEntries);
                    txPrizeName = tx.order.prizeName || 'Prize';
                    txStatus = tx.order.status || txStatus;
                    isPaid = tx.order.isPaid || false; // Check isPaid flag
                } else if (isDonation && tx.donation) {
                    txEntries = 0; // Donations don't have entries
                    // First try the stored amount field, then fall back to invoice data
                    txTotal = tx.donation.amount ||
                        tx.donation.invoiceData?.amount ||
                        tx.donation.invoiceData?.priceAmount ||
                        tx.invoiceData?.amount ||
                        tx.invoiceData?.priceAmount || 0;
                    txPrizeName = tx.donation.name || 'Donation';
                    txCost = txTotal; // For donations, cost = total
                    isPaid = tx.donation.isPaid || false; // Check isPaid flag
                } else {
                    // Fallback to old format for backward compatibility
                    txEntries = tx.entries || (tx.isDonation ? 0 : 1);
                    txCost = tx.cost || 0;
                    txTotal = txCost * txEntries;
                    txPrizeName = tx.prizeName || tx.donationName || tx.prize?.name || tx.donation?.name || 'Transaction';
                }

                // Status configuration - prioritize isPaid flag for accurate display
                let statusConfig = { color: 'bg-gray-400', icon: 'circle', label: txStatus };
                let displayStatus = txStatus;

                // If payment is completed, show "Paid" status (green)
                if (isPaid && (txStatus === 'active' || txStatus === 'pendingPayment')) {
                    statusConfig = { color: 'bg-green-500', icon: 'check-circle', label: 'Paid' };
                    displayStatus = 'Paid';
                } else if (txStatus === 'active' || txStatus === 'pendingPayment') {
                    statusConfig = { color: 'bg-blue-500', icon: 'hourglass', label: 'Pending Payment' };
                    displayStatus = 'Pending Payment';
                } else if (txStatus === 'drawn') {
                    statusConfig = { color: 'bg-yellow-500', icon: 'check', label: 'Drawn' };
                    displayStatus = 'Drawn';
                } else if (txStatus === 'winner' || txStatus === 'drawnWinner' || (txStatus && txStatus.includes('Winner'))) {
                    statusConfig = { color: 'bg-green-500', icon: 'trophy', label: 'Winner' };
                    displayStatus = 'Winner';
                } else if (txStatus === 'completed' || (isDonation && isPaid)) {
                    statusConfig = { color: 'bg-purple-500', icon: 'heart', label: 'Completed' };
                    displayStatus = isDonation ? 'Completed' : 'Completed';
                }

                const txDate = new Date(tx.createdAt || tx.date || tx.order?.dateTimestamp || tx.donation?.dateTimestamp).toLocaleDateString('en-GB');
                const txId = tx._id || tx.id || '';

                return `
                    <tr class="border-b border-gray-200 last:border-b-0 hover:bg-gray-50">
                        <td class="py-3 px-2 sm:px-4 text-xs sm:text-sm text-gray-600">${txDate}</td>
                        <td class="py-3 px-2 sm:px-4 font-medium text-gray-800 text-xs sm:text-sm">${txPrizeName}</td>
                        <td class="py-3 px-2 sm:px-4 text-center text-gray-600 text-xs sm:text-sm">${isDonation ? '-' : txEntries}</td>
                        <td class="py-3 px-2 sm:px-4 text-center font-semibold text-accent text-xs sm:text-sm">$${txTotal.toLocaleString()}</td>
                        <td class="py-3 px-2 sm:px-4 text-center">
                            <span class="inline-flex items-center px-2 py-0.5 sm:px-2.5 sm:py-1 rounded-full text-[10px] sm:text-xs font-medium text-white ${statusConfig.color}">
                                <i data-lucide="${statusConfig.icon}" class="w-2 h-2 sm:w-3 sm:h-3 mr-1 sm:mr-1.5"></i> ${displayStatus}
                            </span>
                        </td>
                        <td class="py-3 px-2 sm:px-4 text-right">${txId ? `<button onclick="handleViewTransaction('${txId}')" class="text-accent text-xs sm:text-sm font-semibold">View</button>` : '<span class="text-gray-400 text-xs sm:text-sm">-</span>'}</td>
                    </tr>
                `;
            }).join('');

            // Adjusted grid classes for stats boxes
            const overviewContent = `
                <div class="space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg text-center border"><p class="text-xl sm:text-2xl font-bold text-accent">${userStats.totalOrders}</p><p class="text-xs sm:text-sm text-gray-500">Total Orders</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center border"><p class="text-xl sm:text-2xl font-bold text-accent">${userStats.totalEntries.toLocaleString()}</p><p class="text-xs sm:text-sm text-gray-500">Total Entries</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center border"><p class="text-xl sm:text-2xl font-bold text-accent">$${userStats.totalSpent.toLocaleString()}</p><p class="text-xs sm:text-sm text-gray-500">Total Spent</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center border"><p class="text-xl sm:text-2xl font-bold text-accent">${userStats.prizesWon}</p><p class="text-xs sm:text-sm text-gray-500">Prizes Won</p></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md border">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-0 p-4 sm:p-6 border-b">Transaction History</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-left">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="py-3 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600">Date</th>
                                        <th class="py-3 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600">Item</th>
                                        <th class="py-3 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600 text-center">Entries</th>
                                        <th class="py-3 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600 text-center">Cost</th>
                                        <th class="py-3 px-2 sm:px-4 text-xs sm:text-sm font-semibold text-gray-600 text-center">Status</th>
                                        <th class="py-3 px-2 sm:px-4"></th> <!-- View Button Column --></tr>
                                </thead>
                                <tbody>
                                    ${transactionsHtml.length > 0 ? transactionsHtml : '<tr><td colspan="6" class="text-center py-12 text-gray-500">No transactions yet.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const settingsContent = `
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-xl font-bold border-b pb-3 mb-6">Profile Settings</h3>
                        <form onsubmit="handleProfileUpdate(event)" class="space-y-6">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="settings-pfp" class="w-20 h-20 rounded-full object-cover" src="${displayPfp}" onerror="this.src='${FALLBACK_IMAGE}'; this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden'); this.nextElementSibling.classList.add('flex');"/>
                                    <div id="settings-initials" class="w-20 h-20 rounded-full bg-gray-200 text-gray-700 justify-center items-center font-bold text-3xl hidden">${displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}</div>
                                    <button type="button" onclick="handleChangeProfilePicture()" class="absolute -bottom-1 -right-1 bg-white p-1.5 rounded-full shadow border"><i data-lucide="camera" class="w-4 h-4"></i></button>
                                </div>
                                <div>
                                    <p class="font-bold text-lg">${displayName}</p>
                                    <p class="text-sm text-gray-500">Member since ${new Date(memberSince).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</p>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-2 gap-4 pt-4">
                                <div>
                                    <label class="text-sm font-medium">Full Name</label>
                                    <input id="settings-fullname" type="text" value="${displayName}" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                </div>
                                <div>
                                    <label class="text-sm font-medium">Phone Number</label>
                                    <input id="settings-phone" type="tel" value="${_cu.phoneNumber || ''}" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                </div>
                            </div>

                            <div>
                                <label class="text-sm font-medium">Email Address</label>
                                <input id="settings-email" type="email" value="${displayEmail}" class="mt-1 w-full p-2 rounded-lg bg-gray-200 text-gray-500" disabled>
                            </div>

                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-900">Billing Address</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium">Street Address</label>
                                        <input id="settings-street" type="text" value="${_cu.billingAddress?.street || ''}" placeholder="123 Main St" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">City</label>
                                        <input id="settings-city" type="text" value="${_cu.billingAddress?.city || ''}" placeholder="London" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">State/Region</label>
                                        <input id="settings-state" type="text" value="${_cu.billingAddress?.state || ''}" placeholder="London" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">Postal Code</label>
                                        <input id="settings-postal" type="text" value="${_cu.billingAddress?.postalCode || ''}" placeholder="SW1A 1AA" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-sm font-medium">Country</label>
                                        <input id="settings-country" type="text" value="${_cu.billingAddress?.country || ''}" placeholder="United Kingdom" class="mt-1 w-full p-2 rounded-lg bg-gray-100 border-gray-300">
                                    </div>
                                </div>
                            </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-xl font-bold border-b pb-3 mb-4">Notifications</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="font-medium">New Prize Alerts</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input id="notif-newPrizes" type="checkbox" ${notifications.prizeAlert ? 'checked' : ''} class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full toggle-bg"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="font-medium">Draw Results</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input id="notif-drawResults" type="checkbox" ${notifications.drawResults ? 'checked' : ''} class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full toggle-bg"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="font-medium">Newsletter</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input id="notif-newsletter" type="checkbox" ${notifications.newsLetter ? 'checked' : ''} class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full toggle-bg"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                            <div class="text-right pt-2">
                                <button type="submit" class="w-full bg-accent hover:bg-accent-dark text-white font-semibold py-2 px-6 rounded-lg">Save Changes</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="text-xl font-bold border-b pb-3 mb-4">Change Password</h3>
                        <form id="password-form" onsubmit="handlePasswordUpdate(event)" class="space-y-4">
                            <div>
                                <label class="text-sm font-medium">Current Password</label>
                                <input type="password" required class="mt-1 w-full p-2 rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="text-sm font-medium">New Password</label>
                                <input type="password" required class="mt-1 w-full p-2 rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="text-sm font-medium">Confirm New Password</label>
                                <input type="password" required class="mt-1 w-full p-2 rounded-lg bg-gray-100">
                            </div>
                            <div class="text-right pt-2"><button type="submit" class="bg-accent text-white font-semibold py-2 px-6 rounded-lg">Update Password</button></div>
                        </form>
                    </div>


                </div>
            `;

            const html = `
                <div class="space-y-10">
                    <h1 class="text-4xl font-extrabold pb-4 border-b border-gray-200">My Account</h1>
                    <div class="grid lg:grid-cols-4 gap-8">
                        <div class="lg:col-span-1"><div class="bg-white p-3 rounded-xl shadow-md border sticky top-24 space-y-1"><a href="#" onclick="switchProfileTab('overview', event)" class="profile-nav-link ${currentProfileTab === 'overview' ? 'active' : ''}"><i data-lucide="layout-grid" class="w-5 h-5 mr-3"></i>Overview</a><a href="#" onclick="switchProfileTab('settings', event)" class="profile-nav-link ${currentProfileTab === 'settings' ? 'active' : ''}"><i data-lucide="settings" class="w-5 h-5 mr-3"></i>Settings</a></div></div>
                        <div class="lg:col-span-3">${currentProfileTab === 'overview' ? overviewContent : settingsContent}</div>
                    </div>
                </div>
            `;
            mainContentEl.innerHTML = html;

            // Post-render logic for profile pic initials display
            const pfpImg = document.getElementById('settings-pfp');
            const initialsDiv = document.getElementById('settings-initials');
            if (pfpImg && initialsDiv) {
                const hasPfp = displayPfp && displayPfp !== 'null' && displayPfp !== 'undefined';
                pfpImg.classList.toggle('hidden', !hasPfp);
                initialsDiv.classList.toggle('hidden', hasPfp);
                initialsDiv.classList.toggle('flex', !hasPfp); // Make sure flex is added if shown
            }


            lucide.createIcons();
        }

        // Hide loading screen function
        window.hideLoading = function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                // Force hide immediately as well
                loadingScreen.style.display = 'none';
                // Remove from DOM after transition
                setTimeout(() => {
                    if (loadingScreen.parentNode) {
                        loadingScreen.parentNode.removeChild(loadingScreen);
                    }
                }, 500);
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            renderHeader();
            lucide.createIcons();
            // Hide loading screen after 3 seconds as fallback (in case data doesn't load)
            setTimeout(() => {
                if (document.getElementById('loading-screen')) {
                    hideLoading();
                }
            }, 3000);

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', openMobileMenu);
            }
            window.addEventListener('click', (e) => {
                if (!document.getElementById('auth-container')?.contains(e.target)) {
                    document.getElementById('profile-dropdown')?.classList.add('hidden');
                }
                if (!mobileMenu.contains(e.target) && !hamburgerBtn.contains(e.target) && mobileMenu.classList.contains('menu-open')) {
                    closeMobileMenu();
                }
            });
        });
    </script>

</body>

</html>